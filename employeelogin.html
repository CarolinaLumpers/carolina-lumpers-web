<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Cache Version Control - Update this timestamp when deploying -->
  <script>
    const CACHE_VERSION = '20251111-0100'; // Format: YYYYMMDD-HHMM
  </script>
  
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-JPETF03TJ0"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-JPETF03TJ0');
  </script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-en="Employee Login | Carolina Lumper Service" data-es="Inicio de Sesi√≥n | Carolina Lumper Service"
    data-pt="Login de Funcion√°rio | Carolina Lumper Service">
    Employee Login | Carolina Lumper Service
  </title>

  <link rel="icon" type="image/png" href="assets/CLS-favicon.png">
  <link rel="manifest" href="manifest-employee.json">
  <meta name="theme-color" content="#ffcc00">
  
  <!-- iOS PWA Support -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="CLS Employee">
  <link rel="apple-touch-icon" href="assets/CLS-icon-192.png">
  
  <link href="https://fonts.googleapis.com/css2?family=Anton&display=swap" rel="stylesheet">
  <script>
    // Apply cache version to stylesheets dynamically
    document.write('<link rel="stylesheet" href="css/style.css?v=' + CACHE_VERSION + '">');
    document.write('<link rel="stylesheet" href="css/forms.css?v=' + CACHE_VERSION + '">');
  </script>
  
  <style>
    /* Full-Screen Loading Overlay */
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      backdrop-filter: blur(10px);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }
    
    .loading-overlay.active {
      display: flex;
    }
    
    .loading-content {
      text-align: center;
      color: #FFC107;
    }
    
    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255, 193, 7, 0.2);
      border-top-color: #FFC107;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    .loading-text {
      font-size: 18px;
      font-weight: 500;
      margin: 0;
      color: #FFC107;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>

</head>

<body data-page="login">
  <!-- Full-Screen Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <p id="loadingText" class="loading-text">Loading...</p>
    </div>
  </div>

  <!-- NAVBAR -->
  <div id="navbar-container"></div>

  <!-- LOGIN FORM (centered vertically) -->
  <main>
    <!-- PWA Install Prompt -->
    <div id="pwaInstallBanner" class="pwa-banner" style="display:none;">
      <span data-en="üì≤ Install CLS Employee App for faster access and offline features!"
            data-es="üì≤ ¬°Instala la App de Empleado CLS para un acceso m√°s r√°pido y funciones sin conexi√≥n!"
            data-pt="üì≤ Instale o App de Funcion√°rio CLS para acesso mais r√°pido e recursos offline!">
        üì≤ Install CLS Employee App for faster access and offline features!
      </span>
      <div class="pwa-buttons">
        <button id="installPwaBtn" class="pwa-install-btn">Install</button>
        <button id="dismissPwaBtn" class="pwa-dismiss-btn">Later</button>
      </div>
    </div>
    
    <!-- Offline Status Indicator -->
    <div id="offlineIndicator" style="display: none; background: #ff9800; color: #000; padding: 8px; text-align: center; font-size: 0.9em;">
      üì± You're offline - Some features may be limited
    </div>

    <div class="login-container">
      <h1 data-en="Employee Login" data-es="Inicio de Sesi√≥n de Empleado" data-pt="Login de Funcion√°rio">Employee Login</h1>

      <form id="loginForm" class="amber-glow">
        <input type="email" id="email" name="email" autocomplete="email" placeholder="Work Email" 
               data-en="Work Email" data-es="Correo de Trabajo" data-pt="Email de Trabalho" required>
        <input type="password" id="password" name="password" autocomplete="current-password" placeholder="Password" 
               data-en="Password" data-es="Contrase√±a" data-pt="Senha" required>

        <button type="submit" id="loginBtn" data-en="Login" data-es="Iniciar Sesi√≥n" data-pt="Entrar">Login</button>
        
        <p id="status" class="message" role="status" aria-live="polite"></p>
      </form>

      <div class="link">
        <span data-en="Don‚Äôt have an account?" data-es="¬øNo tienes una cuenta?" data-pt="N√£o tem uma conta?">Don‚Äôt have
          an account?</span>
        <a href="employeeSignup.html" data-en="Sign Up" data-es="Reg√≠strate" data-pt="Cadastre-se">Sign Up</a>
      </div>
    </div>
  </main>

  <!-- FOOTER -->
  <div id="footer-container"></div>

  <!-- PWA Service Worker Registration -->
  <script>
    // Service Worker Registration with cache version
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker-employee.js?v=' + CACHE_VERSION, { scope: './' })
        .then(registration => {
          console.log('‚úÖ SW ready on login page:', registration.scope);
          console.log('üì¶ Cache version:', CACHE_VERSION);
          
          // Listen for updates
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                console.log('üîÑ New SW version available');
              }
            });
          });
        })
        .catch(err => console.error('‚ùå SW registration failed:', err));
    }
    
    // Initialize page-specific functionality after DOM is ready
    // This will run after the deferred script.js has loaded and initialized
    function initLoginPageFeatures() {
      console.log('üîß Login page: Initializing page-specific features');
      
      // Update offline indicator
      function updateOfflineStatus() {
        const indicator = document.getElementById('offlineIndicator');
        if (indicator) {
          indicator.style.display = navigator.onLine ? 'none' : 'block';
        }
      }
      
      updateOfflineStatus();
      
      // ‚úÖ Check for valid session and auto-redirect (both online and offline)
      function checkActiveSessionAndRedirect() {
        const workerId = localStorage.getItem('CLS_WorkerID');
        const rememberUser = localStorage.getItem('CLS_RememberUser');
        const sessionExpiry = localStorage.getItem('CLS_SessionExpiry');
        
        // Check if user has valid session
        if (workerId && rememberUser === 'true') {
          // If sessionExpiry exists, validate it; otherwise, session is infinite
          const isSessionValid = !sessionExpiry || new Date(sessionExpiry) > new Date();
          
          if (isSessionValid) {
            const displayName = localStorage.getItem('CLS_WorkerName') || workerId;
            console.log(`‚úÖ Valid session found for ${displayName}, auto-redirecting to dashboard`);
            
            // Show friendly message
            const statusEl = document.getElementById('status');
            if (statusEl) {
              statusEl.textContent = `‚úÖ Welcome back, ${displayName}! Redirecting...`;
              statusEl.style.color = '#4CAF50';
            }
            
            // Redirect to dashboard
            setTimeout(() => {
              window.location.href = 'employeeDashboard.html';
            }, 800);
            return true; // Session valid, redirecting
          } else {
            // Session expired, clear it
            console.log('‚ö†Ô∏è Session expired, clearing localStorage');
            localStorage.removeItem('CLS_SessionExpiry');
          }
        }
        
        // No valid session, check if offline and show appropriate message
        if (!navigator.onLine) {
          const statusEl = document.getElementById('status');
          if (statusEl) {
            statusEl.textContent = 'üì± Offline: Please reconnect to log in or try again when online.';
            statusEl.style.color = '#FFC107';
          }
        }
        
        return false; // No redirect
      }
      
      checkActiveSessionAndRedirect();
      
      // Listen for online/offline events
      window.addEventListener('offline', () => {
        console.log('üì± Device went offline');
        updateOfflineStatus();
        checkOfflineAccess();
      });
      
      window.addEventListener('online', () => {
        console.log('üåê Device back online');
        updateOfflineStatus();
        const statusEl = document.getElementById('status');
        if (statusEl && statusEl.textContent.includes('Offline:')) {
          statusEl.textContent = '';
        }
      });
    }
    
    // Initialize when DOM is ready OR immediately if already ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initLoginPageFeatures);
    } else {
      // DOM is already ready
      setTimeout(initLoginPageFeatures, 100); // Small delay to ensure script.js has run
    }
    
    // Comprehensive failsafe system
    setTimeout(() => {
      console.log('üõ°Ô∏è Running comprehensive failsafe checks...');
      
      // Ensure login form is initialized
      if (window.initLoginForm && document.getElementById('loginForm')) {
        const form = document.getElementById('loginForm');
        if (!form.hasAttribute('data-initialized')) {
          console.log('üö® Failsafe: Initializing login form manually');
          window.initLoginForm();
        } else {
          console.log('‚úÖ Failsafe check: Login form already properly initialized');
        }
      }
    }, 1500);
  </script>

  <!-- Cache Busting Utility -->
  <script>
    // Apply cache version to scripts dynamically
    document.write('<script src="js/cache-buster.js?v=' + CACHE_VERSION + '" defer><\/script>');
    document.write('<script src="js/script.js?v=' + CACHE_VERSION + '" defer><\/script>');
  </script>
</body>

</html>