<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Apply to Carolina Lumper Service (CLS)</title>

  <!-- Core styles (same as site) -->
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/forms.css">
  <link rel="icon" type="image/png" href="assets/CLS-favicon.png">
  <link href="https://fonts.googleapis.com/css2?family=Anton&display=swap" rel="stylesheet">
</head>

<body data-page="apply">
  <!-- Navbar -->
  <div id="navbar-container"></div>

  <!-- Hero -->
  <header class="hero">
    <div class="hero-content container text-center">
      <h2 data-en="Join the CLS Team" data-es="Únete al Equipo CLS" data-pt="Junte-se à Equipe CLS">
        Join the CLS Team
      </h2>
      <p
        data-en="We are looking for motivated individuals to join our team. Fill out the application below to get started!"
        data-es="Estamos buscando personas motivadas para unirse a nuestro equipo. ¡Complete la solicitud abajo para comenzar!"
        data-pt="Estamos procurando pessoas motivadas para se juntar à nossa equipe. Preencha o formulário abaixo para começar!"
      >
        We are looking for motivated individuals to join our team. Fill out the application below to get started!
      </p>
    </div>
    <div class="hero-image">
      <img src="assets/CLS-Cover-01web.webp" alt="Hero Banner" class="banner-image">
      <div class="blur-overlay"></div>
    </div>
  </header>

  <!-- Application -->
  <main class="container">
    <section id="apply" class="section-container">
      <div class="form-container">
        <h2 data-en="Apply for a Position" data-es="Solicitar un Puesto" data-pt="Candidatar-se a uma Posição">
          Apply for a Position
        </h2>
        <p
          data-en="Interested in joining our team? Complete the form below:"
          data-es="¿Interesado en unirte a nuestro equipo? Completa el formulario abajo:"
          data-pt="Interessado em se juntar à nossa equipe? Complete o formulário abaixo:"
        >
          Interested in joining our team? Complete the form below:
        </p>

        <!-- Progress -->
        <div class="progress" aria-live="polite">
          <div class="progress-top">
            <strong id="stepLabel">Step 1 of 6</strong>
            <span id="stepName">Personal Information</span>
          </div>
          <div class="bar"><div class="bar-fill" id="barFill"></div></div>
          <div class="steps" id="stepsDots"></div>
        </div>

        <!-- Form -->
        <form id="applicationForm"
              action="https://script.google.com/macros/s/AKfycbxdD80YrBa6wa271_TtCpwWnQJbQfeRjZVe0iRkAdO36D_t3E44foSn11IdCEq1iJ6OSg/exec"
              method="POST" novalidate>
          <!-- Hidden meta + honeypot -->
          <input type="hidden" name="startedAt" value="">
          <input type="hidden" name="ui_lang" value="en">
          <div style="position:absolute;left:-10000px" aria-hidden="true">
            <span data-en="Website" data-es="Sitio web" data-pt="Site">Website</span>
            <input name="website" tabindex="-1" autocomplete="off">
          </div>

          <!-- STEP 1: Personal Information -->
          <section class="form-step active" data-title="Personal Information" data-en="Personal Information" data-es="Información personal" data-pt="Informações pessoais">
            <div class="form-grid">
              <label for="first_name" class="required" data-en="First name" data-es="Nombre" data-pt="Nome">First name</label>
              <input id="first_name" name="first_name" required minlength="2" autocomplete="given-name"
                     data-ph-en="First name" data-ph-es="Nombre" data-ph-pt="Nome">

              <label for="last_name" class="required" data-en="Last name" data-es="Apellido" data-pt="Sobrenome">Last name</label>
              <input id="last_name" name="last_name" required minlength="2" autocomplete="family-name"
                     data-ph-en="Last name" data-ph-es="Apellido" data-ph-pt="Sobrenome">

              <label for="dob" class="required" data-en="Date of Birth" data-es="Fecha de nacimiento" data-pt="Data de nascimento">
                Date of Birth
              </label>
              <input id="dob" name="dob" type="date" required max="" title="You must be at least 18 years old">
              <span id="dobError" style="color:#d00;font-size:13px;display:none;"></span>

              <label for="email" class="required" data-en="Email" data-es="Correo electrónico" data-pt="E-mail">Email</label>
              <input id="email" name="email" type="email" required autocomplete="email"
                     data-ph-en="you@example.com" data-ph-es="tu@ejemplo.com" data-ph-pt="voce@exemplo.com">

              <label for="phone" class="required" data-en="Phone" data-es="Teléfono" data-pt="Telefone">Phone</label>
              <input id="phone" name="phone" type="tel" inputmode="tel" required autocomplete="tel"
                     data-ph-en="(555) 555-1212" data-ph-es="(555) 555-1212" data-ph-pt="(11) 5555-1212">
            </div>
          </section>

          <!-- STEP 2: Location & Transportation -->
          <section class="form-step" data-title="Location & Transportation" data-en="Location & Transportation" data-es="Ubicación y transporte" data-pt="Local e transporte">
            <div class="form-grid">
              <label for="city" class="required" data-en="City" data-es="Ciudad" data-pt="Cidade">City</label>
              <input id="city" name="city" required autocomplete="address-level2" data-ph-en="City" data-ph-es="Ciudad" data-ph-pt="Cidade">

              <label for="state" class="required" data-en="State" data-es="Estado" data-pt="Estado">State</label>
              <select id="state" name="state" required autocomplete="address-level1">
                <option value=""></option>
                <option value="AL">Alabama</option><option value="AK">Alaska</option><option value="AZ">Arizona</option>
                <option value="AR">Arkansas</option><option value="CA">California</option><option value="CO">Colorado</option>
                <option value="CT">Connecticut</option><option value="DE">Delaware</option><option value="FL">Florida</option>
                <option value="GA">Georgia</option><option value="HI">Hawaii</option><option value="ID">Idaho</option>
                <option value="IL">Illinois</option><option value="IN">Indiana</option><option value="IA">Iowa</option>
                <option value="KS">Kansas</option><option value="KY">Kentucky</option><option value="LA">Louisiana</option>
                <option value="ME">Maine</option><option value="MD">Maryland</option><option value="MA">Massachusetts</option>
                <option value="MI">Michigan</option><option value="MN">Minnesota</option><option value="MS">Mississippi</option>
                <option value="MO">Missouri</option><option value="MT">Montana</option><option value="NE">Nebraska</option>
                <option value="NV">Nevada</option><option value="NH">New Hampshire</option><option value="NJ">New Jersey</option>
                <option value="NM">New Mexico</option><option value="NY">New York</option><option value="NC">North Carolina</option>
                <option value="ND">North Dakota</option><option value="OH">Ohio</option><option value="OK">Oklahoma</option>
                <option value="OR">Oregon</option><option value="PA">Pennsylvania</option><option value="RI">Rhode Island</option>
                <option value="SC">South Carolina</option><option value="SD">South Dakota</option><option value="TN">Tennessee</option>
                <option value="TX">Texas</option><option value="UT">Utah</option><option value="VT">Vermont</option>
                <option value="VA">Virginia</option><option value="WA">Washington</option><option value="WV">West Virginia</option>
                <option value="WI">Wisconsin</option><option value="WY">Wyoming</option>
              </select>

              <label for="transportation" class="required" data-en="Reliable Transportation" data-es="Transporte confiable" data-pt="Transporte confiável">
                Reliable Transportation
              </label>
              <select id="transportation" name="transportation" required>
                <option value=""></option>
                <option value="Yes" data-en="Yes" data-es="Sí" data-pt="Sim">Yes</option>
                <option value="No" data-en="No" data-es="No" data-pt="Não">No</option>
              </select>

              <label for="driver_license" data-en="Valid Driver's License" data-es="Licencia de conducir válida" data-pt="Carteira de motorista válida">
                Valid Driver's License
              </label>
              <select id="driver_license" name="driver_license">
                <option value=""></option>
                <option value="Yes" data-en="Yes" data-es="Sí" data-pt="Sim">Yes</option>
                <option value="No" data-en="No" data-es="No" data-pt="Não">No</option>
              </select>

              <label for="overtime_ok" data-en="Willing to Work Overtime" data-es="Dispuesto a trabajar horas extra" data-pt="Disposto a fazer horas extras">
                Willing to Work Overtime
              </label>
              <select id="overtime_ok" name="overtime_ok">
                <option value=""></option>
                <option value="Yes" data-en="Yes" data-es="Sí" data-pt="Sim">Yes</option>
                <option value="No" data-en="No" data-es="No" data-pt="Não">No</option>
              </select>

              <label for="travel_ok" data-en="Willing to Travel" data-es="Dispuesto a viajar" data-pt="Disposto a viajar">
                Willing to Travel
              </label>
              <select id="travel_ok" name="travel_ok">
                <option value=""></option>
                <option value="Yes" data-en="Yes" data-es="Sí" data-pt="Sim">Yes</option>
                <option value="No" data-en="No" data-es="No" data-pt="Não">No</option>
              </select>
            </div>
          </section>

          <!-- STEP 3: Work Authorization & Start -->
          <section class="form-step" data-title="Work Authorization & Start" data-en="Work Authorization & Start" data-es="Autorización y inicio" data-pt="Autorização e início">
            <div class="form-grid">
              <label for="work_authorization" class="required"
                     data-en="Work Authorization" data-es="Autorización de trabajo" data-pt="Autorização de trabalho">
                Work Authorization
              </label>
              <select id="work_authorization" name="work_authorization" required>
                <option value=""></option>
                <option value="Citizen" data-en="US Citizen" data-es="Ciudadano de EE. UU." data-pt="Cidadão dos EUA">US Citizen</option>
                <option value="Permanent Resident" data-en="Permanent Resident" data-es="Residente Permanente" data-pt="Residente Permanente">Permanent Resident</option>
                <option value="Work Permit (EAD)" data-en="Work Permit (EAD)" data-es="Permiso de Trabajo (EAD)" data-pt="Permissão de Trabalho (EAD)">Work Permit (EAD)</option>
                <option value="Visa (H-2B)" data-en="Visa (H-2B)" data-es="Visa (H-2B)" data-pt="Visto (H-2B)">Visa (H-2B)</option>
                <option value="Visa (Other)" data-en="Other Visa" data-es="Otra Visa" data-pt="Outro Visto">Other Visa</option>
                <option value="Not Authorized" data-en="Not Authorized" data-es="No Autorizado" data-pt="Não Autorizado">Not Authorized</option>
              </select>
              <small id="authDescription" style="display:block;color:#bbb;font-size:0.9em;margin-top:4px;"></small>
              <small id="docNote" style="display:block;color:#ffcc00;font-size:0.9em;margin-top:4px;"></small>

              <label for="start_date" class="required"
                     data-en="Available Start Date" data-es="Fecha de inicio disponible" data-pt="Data de início disponível">
                Available Start Date
              </label>
              <input id="start_date" name="start_date" type="date" required>
            </div>
          </section>

          <!-- STEP 4: Job Preferences & Experience -->
          <section class="form-step" data-title="Job Preferences & Experience" data-en="Job Preferences & Experience" data-es="Preferencias y experiencia" data-pt="Preferências e experiência">
            <div class="form-grid">
              <label for="site" data-en="Preferred site" data-es="Sitio preferido" data-pt="Site preferido">Preferred site</label>
              <select id="site" name="site">
                <option value=""></option>
                <option value="Matthews" data-en="CLT - Matthews" data-es="CLT - Matthews" data-pt="CLT - Matthews">CLT - Matthews</option>
                <option value="Steel Creek" data-en="CLT - Steel Creek" data-es="CLT - Steel Creek" data-pt="CLT - Steel Creek">CLT - Steel Creek</option>
              </select>

              <label for="shift_preference" data-en="Preferred shift" data-es="Turno preferido" data-pt="Turno preferido">Preferred shift</label>
              <select id="shift_preference" name="shift_preference">
                <option value=""></option>
                <option value="Day" data-en="Day" data-es="Día" data-pt="Dia">Day</option>
                <option value="Evening" data-en="Evening" data-es="Tarde" data-pt="Tarde">Evening</option>
                <option value="Night" data-en="Night" data-es="Noche" data-pt="Noite">Night</option>
                <option value="Weekends" data-en="Weekends" data-es="Fines de semana" data-pt="Fins de semana">Weekends</option>
              </select>

              <label for="experience_level" data-en="Experience level" data-es="Experiencia" data-pt="Experiência">Experience level</label>
              <select id="experience_level" name="experience_level">
                <option value=""></option>
                <option value="None" data-en="None" data-es="Ninguna" data-pt="Nenhuma">None</option>
                <option value="0–6 months" data-en="0–6 months" data-es="0–6 meses" data-pt="0–6 meses">0–6 months</option>
                <option value="6–12 months" data-en="6–12 months" data-es="6–12 meses" data-pt="6–12 meses">6–12 months</option>
                <option value="1–3 years" data-en="1–3 years" data-es="1–3 años" data-pt="1–3 anos">1–3 years</option>
                <option value="3+ years" data-en="3+ years" data-es="3+ años" data-pt="3+ anos">3+ years</option>
              </select>

              <label for="equipment_experience" data-en="Equipment Experience" data-es="Experiencia con equipos" data-pt="Experiência com equipamentos">
                Equipment Experience
              </label>
              <input id="equipment_experience" name="equipment_experience"
                     data-ph-en="Forklift, pallet jack" data-ph-es="Montacargas, patín hidráulico" data-ph-pt="Empilhadeira, paleteira">

              <label for="notes" data-en="Notes" data-es="Notas" data-pt="Observações">Notes</label>
              <textarea id="notes" name="notes" rows="4"
                        data-ph-en="Certifications, availability, locations"
                        data-ph-es="Certificados, disponibilidad, ubicaciones"
                        data-ph-pt="Certificados, disponibilidade, locais"></textarea>
            </div>
          </section>

          <!-- STEP 5: Emergency Contact -->
          <section class="form-step" data-title="Emergency Contact" data-en="Emergency Contact" data-es="Contacto de emergencia" data-pt="Contato de emergência">
            <div class="form-grid">
              <label for="emergency_contact_name" class="required"
                     data-en="Emergency Contact Name" data-es="Nombre del contacto de emergencia" data-pt="Nome do contato de emergência">
                Emergency Contact Name
              </label>
              <input id="emergency_contact_name" name="emergency_contact_name" required>

              <label for="emergency_contact_relation"
                     data-en="Relationship" data-es="Relación" data-pt="Relação">
                Relationship
              </label>
              <input id="emergency_contact_relation" name="emergency_contact_relation">

              <label for="emergency_contact_phone" class="required"
                     data-en="Emergency Contact Phone" data-es="Teléfono del contacto de emergencia" data-pt="Telefone do contato de emergência">
                Emergency Contact Phone
              </label>
              <input id="emergency_contact_phone" name="emergency_contact_phone" type="tel" required>
            </div>
          </section>

          <!-- STEP 6: Language & Privacy -->
          <section class="form-step" data-title="Language & Privacy" data-en="Language & Privacy" data-es="Idioma y privacidad" data-pt="Idioma e privacidade">
            <div class="form-grid">
              <label for="language_preference" class="required"
                     data-en="Language preference" data-es="Idioma preferido" data-pt="Idioma preferido">
                Language preference
              </label>
              <select id="language_preference" name="language_preference" required>
                <option value=""></option>
                <option value="English" data-en="English" data-es="Inglés" data-pt="Inglês">English</option>
                <option value="Spanish" data-en="Spanish" data-es="Español" data-pt="Espanhol">Spanish</option>
                <option value="Portuguese" data-en="Portuguese" data-es="Portugués" data-pt="Português">Portuguese</option>
                <option value="Other" data-en="Other" data-es="Otro" data-pt="Outro">Other</option>
              </select>

              <label for="english_proficiency" class="required"
                     data-en="English proficiency" data-es="Dominio del inglés" data-pt="Proficiência em inglês">
                English proficiency
              </label>
              <select id="english_proficiency" name="english_proficiency" required>
                <option value=""></option>
                <option value="Basic" data-en="Basic" data-es="Básico" data-pt="Básico">Basic</option>
                <option value="Conversational" data-en="Conversational" data-es="Conversacional" data-pt="Conversacional">Conversational</option>
                <option value="Fluent" data-en="Fluent" data-es="Fluido" data-pt="Fluente">Fluent</option>
                <option value="Native" data-en="Native" data-es="Nativo" data-pt="Nativo">Native</option>
              </select>

              <div class="full">
                <label>
                  <input type="checkbox" name="consent" required>
                  <span
                    data-en='I agree to the <a href="privacyApp.html" target="_blank" style="color:#ffcc00;text-decoration:underline;">Privacy Policy</a>'
                    data-es='Acepto la <a href="privacyApp.html" target="_blank" style="color:#ffcc00;text-decoration:underline;">Política de Privacidad</a>'
                    data-pt='Concordo com a <a href="privacyApp.html" target="_blank" style="color:#ffcc00;text-decoration:underline;">Política de Privacidade</a>'>
                    I agree to the <a href="privacyApp.html" target="_blank" style="color:#ffcc00;text-decoration:underline;">Privacy Policy</a>
                  </span>
                </label>
              </div>
            </div>
          </section>

          <!-- Wizard nav -->
          <div class="form-nav">
            <button type="button" id="backBtn" class="btn btn-secondary" style="display:none;">← <span data-en="Back" data-es="Atrás" data-pt="Voltar">Back</span></button>
            <button type="button" id="nextBtn" class="btn btn-primary"><span data-en="Next" data-es="Siguiente" data-pt="Próximo">Next</span> →</button>
            <button type="submit" id="submitBtn" class="btn btn-primary" style="display:none;"><span data-en="Submit application" data-es="Enviar solicitud" data-pt="Enviar candidatura">Submit application</span></button>
          </div>

          <div id="successMsg" class="success" aria-live="polite" style="display:none;">
            ✅ <span data-en="Thanks! Your application has been submitted." data-es="¡Gracias! Su solicitud ha sido enviada." data-pt="Obrigado! Sua candidatura foi enviada.">Thanks! Your application has been submitted.</span>
          </div>
        </form>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <div id="footer-container"></div>

  <!-- Wizard Logic (mirrors contact page, adapted for cls-apply) -->
  <script>
  (function(){
    const form = document.getElementById('applicationForm');
    const steps = Array.from(form.querySelectorAll('.form-step'));
    const stepLabel = document.getElementById('stepLabel');
    const stepName = document.getElementById('stepName');
    const barFill = document.getElementById('barFill');
    const backBtn = document.getElementById('backBtn');
    const nextBtn = document.getElementById('nextBtn');
    const submitBtn = document.getElementById('submitBtn');
    const successMsg = document.getElementById('successMsg');
    const stepsDots = document.getElementById('stepsDots');

    let current = 0;
    const total = steps.length;

    // Age limit for DOB max
    const dobInput = document.getElementById('dob');
    if (dobInput){
      const today = new Date();
      const y = today.getFullYear() - 18;
      const m = String(today.getMonth() + 1).padStart(2, '0');
      const d = String(today.getDate()).padStart(2, '0');
      dobInput.max = `${y}-${m}-${d}`;
    }

    // Step titles → dots
    const titles = steps.map(s => s.dataset.title || 'Step');
    titles.forEach((t,i)=>{
      const dot=document.createElement('button');
      dot.type='button';
      dot.className='step-dot';
      dot.textContent=(i+1);
      dot.title=t;
      dot.addEventListener('click',()=>go(i,true)); // allow back/skip via dots
      stepsDots.appendChild(dot);
    });

    function updateProgress(){
      stepLabel.textContent = `Step ${current+1} of ${total}`;
      stepName.textContent = titles[current];
      barFill.style.transform = `scaleX(${(current+1)/total})`;
      stepsDots.querySelectorAll('.step-dot').forEach((d,i)=>{
        d.setAttribute('aria-current', i===current ? 'step' : 'false');
        d.classList.toggle('done', i<current);
      });
      backBtn.style.display = current === 0 ? 'none' : 'inline-flex';
      nextBtn.style.display = current === total-1 ? 'none' : 'inline-flex';
      submitBtn.style.display = current === total-1 ? 'inline-flex' : 'none';
    }

    function go(n, skip=false){
      if (!skip && n>current && !validateStep(current)) return;
      steps[current].classList.remove('active');
      current = Math.max(0, Math.min(total-1, n));
      steps[current].classList.add('active');
      updateProgress();
      document.getElementById('apply').scrollIntoView({behavior:'smooth'});
    }

    // Safe language update function for form elements
    function updateFormLanguage(lang) {
      // Update form labels and text (safe with textContent)
      form.querySelectorAll('label[data-en]').forEach(label => {
        const text = label.getAttribute(`data-${lang}`) || label.getAttribute('data-en');
        if (text) label.textContent = text;
      });
      
      // Update form section titles
      steps.forEach(step => {
        const text = step.getAttribute(`data-${lang}`) || step.getAttribute('data-en');
        if (text) {
          step.setAttribute('data-title', text);
          // Update progress if this is current step
          if (step.classList.contains('active')) {
            stepName.textContent = text;
          }
        }
      });
      
      // Update option text
      form.querySelectorAll('option[data-en]').forEach(option => {
        const text = option.getAttribute(`data-${lang}`) || option.getAttribute('data-en');
        if (text) option.textContent = text;
      });
      
      // Update button text
      form.querySelectorAll('button span[data-en], .btn span[data-en]').forEach(span => {
        const text = span.getAttribute(`data-${lang}`) || span.getAttribute('data-en');
        if (text) span.textContent = text;
      });
      
      // Update any other translatable elements inside form
      form.querySelectorAll('span[data-en]:not(input span)').forEach(span => {
        const text = span.getAttribute(`data-${lang}`) || span.getAttribute('data-en');
        if (text) {
          // Use innerHTML for spans that contain HTML (like privacy policy links)
          if (text.includes('<a href=')) {
            span.innerHTML = text;
          } else {
            span.textContent = text;
          }
        }
      });
      
      // Update work authorization documentation when language changes
      if (typeof updateDocNote === 'function') {
        updateDocNote();
      }
    }

    // Listen for language changes from the global system
    window.addEventListener('languageChanged', function(e) {
      updateFormLanguage(e.detail.language);
    });
    
    // Apply initial language
    const initialLang = localStorage.getItem("CLS_Lang") || "en";
    updateFormLanguage(initialLang);

    function next(){ go(current+1); }
    function back(){ go(current-1, true); }
    document.getElementById('nextBtn').addEventListener('click', next);
    document.getElementById('backBtn').addEventListener('click', back);

    // Basic validators
    const emailRe = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    function isOver18(dobStr){
      if (!dobStr) return false;
      const today = new Date();
      const dob = new Date(dobStr);
      let age = today.getFullYear() - dob.getFullYear();
      const m = today.getMonth() - dob.getMonth();
      if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) age--;
      return age >= 18;
    }

    function setInvalid(el){ el && el.classList && el.classList.add('invalid'); }
    function clearInvalids(scope){ scope.querySelectorAll('.field, label, select, input').forEach(x=>x.classList && x.classList.remove('invalid')); }

    function validateStep(idx){
      const step = steps[idx];
      clearInvalids(step);
      let ok = true;

      if (idx === 0){ // Personal
        const fn = form.first_name, ln = form.last_name, dob = form.dob, phone = form.phone, email = form.email;
        if (!fn.value.trim()) { setInvalid(fn); ok=false; }
        if (!ln.value.trim()) { setInvalid(ln); ok=false; }
        if (!dob.value || !isOver18(dob.value)) { setInvalid(dob); ok=false; }
        if (!phone.value.trim()) { setInvalid(phone); ok=false; }
        if (!emailRe.test(email.value)) { setInvalid(email); ok=false; }
      }

      if (idx === 1){ // Location & transportation
        const city = form.city, state = form.state, transportation = form.transportation;
        if (!city.value.trim()) { setInvalid(city); ok=false; }
        if (!state.value) { setInvalid(state); ok=false; }
        if (!transportation.value) { setInvalid(transportation); ok=false; }
      }

      if (idx === 2){ // Work authorization
        const wa = form.work_authorization, sd = form.start_date;
        if (!wa.value) { setInvalid(wa); ok=false; }
        if (!sd.value) { setInvalid(sd); ok=false; }
      }

      if (idx === 4){ // Emergency contact
        const name = form.emergency_contact_name, phone = form.emergency_contact_phone;
        if (!name.value.trim()) { setInvalid(name); ok=false; }
        if (!phone.value.trim()) { setInvalid(phone); ok=false; }
      }

      if (idx === 5){ // Language & privacy
        const lang = form.language_preference, eng = form.english_proficiency, consent = form.consent;
        if (!lang.value) { setInvalid(lang); ok=false; }
        if (!eng.value) { setInvalid(eng); ok=false; }
        if (!consent.checked) { setInvalid(consent); ok=false; }
      }
      return ok;
    }

    // Submission via fetch (so we can show on-page success)
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      
      // Validate all required steps before submission
      let allValid = true;
      for (let i = 0; i < total; i++) {
        if (!validateStep(i)) {
          allValid = false;
          // Go to first invalid step
          go(i, true);
          break;
        }
      }
      if (!allValid) return;

      // Set startedAt if empty
      if (!form.startedAt.value) form.startedAt.value = Date.now();

      const endpoint = form.getAttribute('action');
      const fd = new FormData(form);
      
      // Add console logging for debugging
      console.log('Submitting to:', endpoint);
      console.log('Form data:', Object.fromEntries(fd));
      console.log('Form elements check:');
      console.log('first_name:', form.first_name?.value);
      console.log('last_name:', form.last_name?.value);
      console.log('email:', form.email?.value);
      console.log('consent:', form.consent?.checked);

      try{
        const res = await fetch(endpoint, { method:'POST', body: fd });
        console.log('Response status:', res.status);
        
        if (!res.ok) {
          const errorText = await res.text();
          console.error('Submit failed:', errorText);
          throw new Error(`Submit failed: ${res.status}`);
        }
        
        const result = await res.json();
        console.log('Success response:', result);
        
        successMsg.style.display = 'block';
        nextBtn.disabled = true; backBtn.disabled = true; submitBtn.disabled = true;
      }catch(err){
        console.error('Submission error:', err);
        successMsg.textContent = '⚠️ Error submitting application. Please try again.';
        successMsg.style.display = 'block';
      }
    });

    // Init
    steps[0].classList.add('active');
    updateProgress();
    
    // Create observer to watch for external interference
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.type === 'attributes' && 
            mutation.attributeName === 'class' && 
            mutation.target.classList.contains('form-step')) {
          // Re-ensure first step is active if no step is active
          const activeSteps = steps.filter(s => s.classList.contains('active'));
          if (activeSteps.length === 0) {
            steps[current].classList.add('active');
            updateProgress();
          }
        }
      });
    });
    
    // Watch all form steps for class changes
    steps.forEach(step => {
      observer.observe(step, { attributes: true, attributeFilter: ['class'] });
    });
    
    // Additional safety check - re-activate every 500ms for first 3 seconds
    let safetyChecks = 0;
    const safetyInterval = setInterval(() => {
      const activeSteps = steps.filter(s => s.classList.contains('active'));
      if (activeSteps.length === 0) {
        steps[current].classList.add('active');
        updateProgress();
      }
      safetyChecks++;
      if (safetyChecks >= 6) { // 6 * 500ms = 3 seconds
        clearInterval(safetyInterval);
      }
    }, 500);

    // Work Authorization Documentation Function
    function updateDocNote() {
      const select = document.getElementById("work_authorization");
      const val = select.value;
      const note = document.getElementById("docNote");
      // Get language from localStorage (same as global language system)
      const lang = localStorage.getItem("CLS_Lang") || "en";

      const docs = {
        Citizen: {
          en: "Bring your U.S. passport OR both a driver's license and Social Security card for visual verification during onboarding.",
          es: "Lleve su pasaporte estadounidense O tanto su licencia de conducir como su tarjeta del Seguro Social para verificación visual durante la incorporación.",
          pt: "Traga seu passaporte dos EUA OU tanto a carteira de motorista quanto o cartão do Seguro Social para verificação visual durante a integração."
        },
        "Permanent Resident": {
          en: "Bring your Permanent Resident Card (Green Card, Form I-551) for visual verification during onboarding.",
          es: "Lleve su tarjeta de residente permanente (Green Card, Form I-551) para verificación visual durante la incorporación.",
          pt: "Traga seu Cartão de Residente Permanente (Green Card, Form I-551) para verificação visual durante a integração."
        },
        "Work Permit (EAD)": {
          en: "Bring your Employment Authorization Document (EAD, Form I-766) issued by USCIS for visual verification during onboarding.",
          es: "Lleve su Documento de Autorización de Empleo (EAD, Formulario I-766) emitido por USCIS para verificación visual durante la incorporación.",
          pt: "Traga seu Documento de Autorização de Emprego (EAD, Formulário I-766) emitido pelo USCIS para verificação visual durante a integração."
        },
        "Visa (H-2B)": {
          en: "Bring your passport, visa page, and I-94 record for visual verification during onboarding. You can access your I-94 at i94.cbp.dhs.gov.",
          es: "Lleve su pasaporte, página de visa y registro I-94 para verificación visual durante la incorporación. Puede acceder a su I-94 en i94.cbp.dhs.gov.",
          pt: "Traga seu passaporte, página do visto e registro I-94 para verificação visual durante a integração. Você pode acessar seu I-94 em i94.cbp.dhs.gov."
        },
        "Visa (Other)": {
          en: "Bring your passport and any DHS or USCIS authorization letter for visual verification during onboarding.",
          es: "Lleve su pasaporte y cualquier carta de autorización del DHS o USCIS para verificación visual durante la incorporación.",
          pt: "Traga seu passaporte e qualquer carta de autorização do DHS ou USCIS para verificação visual durante a integração."
        },
        "Not Authorized": {
          en: "⚠️ You are not currently authorized to work in the United States. Please obtain proper authorization before employment.",
          es: "⚠️ No está actualmente autorizado para trabajar en los Estados Unidos. Obtenga la autorización correspondiente antes del empleo.",
          pt: "⚠️ Você não está atualmente autorizado a trabalhar nos Estados Unidos. Obtenha a devida autorização antes do emprego."
        }
      };

      if (docs[val]) {
        note.textContent = "📄 " + docs[val][lang];
      } else {
        note.textContent = "";
      }
    }

    // Add event listener for work authorization select
    const workAuthSelect = document.getElementById("work_authorization");
    if (workAuthSelect) {
      workAuthSelect.addEventListener('change', updateDocNote);
      // Also update when language changes
      window.addEventListener('languageChanged', updateDocNote);
    }
  })();
  </script>

  <!-- Site script should come AFTER the wizard -->
  <script src="js/script.js"></script>
</body>
</html>
