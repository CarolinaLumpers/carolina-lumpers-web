<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbwHBLEQ5QHuhD-O4uI4hRN_5_yS9YsFgtn_dMAdoAO2C7zHLoi3qfHO82vas3Uv0wXXpg/exec";
  const SESSION_KEY = "CLS_User";
  const LOGIN_PAGE = "employeelogin.html";
  const MAX_SESSION_AGE = 7 * 24 * 60 * 60 * 1000;

  // --- JSONP helper ---
  function jsonp(url) {
    return new Promise((resolve, reject) => {
      const cb = "cb_" + Math.random().toString(36).slice(2);
      const s = document.createElement("script");
      const sep = url.includes("?") ? "&" : "?";
      s.src = `${url}${sep}callback=${cb}`;
      s.onerror = () => {
        delete window[cb];
        s.remove();
        reject(new Error("Network error"));
      };
      window[cb] = (data) => {
        delete window[cb];
        s.remove();
        resolve(data);
      };
      document.body.appendChild(s);
    });
  }

  // Load session
  let userData = sessionStorage.getItem(SESSION_KEY) || localStorage.getItem(SESSION_KEY);
  if (userData) userData = JSON.parse(userData);
  if (!userData || !userData.workerId) {
    alert("Session expired. Please log in again.");
    window.location.href = LOGIN_PAGE;
  }

  const { workerId, displayName, email } = userData;
  document.getElementById("welcomeMessage").textContent = `Welcome, ${displayName || "Employee"}!`;
  document.getElementById("userInfo").textContent = `Worker ID: ${workerId} | ${email}`;

  function logout() {
    localStorage.removeItem(SESSION_KEY);
    sessionStorage.removeItem(SESSION_KEY);
    window.location.href = LOGIN_PAGE;
  }

  // --- Clock-In via JSONP to MAIN API ---
  document.getElementById("clockInBtn").addEventListener("click", async () => {
    const btn = document.getElementById("clockInBtn");
    const status = document.getElementById("clockInStatus");
    btn.disabled = true;
    status.textContent = "Recording clock-in...";
    try {
      const res = await jsonp(`${API_URL}?action=clockin&workerId=${encodeURIComponent(workerId)}`);
      const text = typeof res === "string" ? res : (res && res.message) || JSON.stringify(res);
      if (text.includes("Clock-in recorded")) {
        status.textContent = "✅ Clock-in successful!";
        loadReport();
      } else {
        status.textContent = text;
      }
    } catch (err) {
      status.textContent = "⚠️ Error: " + err.message;
    } finally {
      btn.disabled = false;
    }
  });

  // --- Weekly Report via JSONP to MAIN API ---
  async function loadReport() {
    const body = document.getElementById("reportBody");
    body.innerHTML = "<tr><td colspan='2'>Loading...</td></tr>";
    try {
      const data = await jsonp(`${API_URL}?action=report&workerId=${encodeURIComponent(workerId)}`);
      body.innerHTML = "";

      if (data && data.records && data.records.length > 0) {
        data.records.forEach(r => {
          // r.date and r.time are already formatted server-side ("MM/dd/yyyy" and "HH:mm:ss")
          const row = document.createElement("tr");
          row.innerHTML = `<td>${r.date || ""}</td><td>${r.time || ""}</td>`;
          body.appendChild(row);
        });
      } else {
        body.innerHTML = '<tr><td colspan="2">No clock-ins this week.</td></tr>';
      }
    } catch (err) {
      body.innerHTML = `<tr><td colspan="2">⚠️ Error loading report: ${err.message}</td></tr>`;
    }
  }

  loadReport();

  // Language switcher (yours)
  function switchLanguage(lang){
    localStorage.setItem("CLS_Lang", lang);
    document.querySelectorAll("[data-en]").forEach(el=>{
      const t = el.getAttribute(`data-${lang}`) || el.getAttribute("data-en");
      if(t) el.innerHTML = t;
    });
    document.querySelectorAll(".language-toggle button").forEach(b =>
      b.classList.toggle("active", b.dataset.lang === lang)
    );
  }
  document.addEventListener("DOMContentLoaded", ()=>{
    const s = localStorage.getItem("CLS_Lang");
    const b = navigator.language || navigator.userLanguage;
    const l = s || (b.startsWith("es") ? "es" : b.startsWith("pt") ? "pt" : "en");
    switchLanguage(l);
  });
</script>
