<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Cache Version Control - Update this timestamp when deploying -->
  <script>
    const CACHE_VERSION = '20251111-1045'; // Format: YYYYMMDD-HHMM
  </script>
  
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-JPETF03TJ0"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-JPETF03TJ0');
  </script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title data-en="Employee Dashboard | Carolina Lumper Service" data-es="Panel del Empleado | Carolina Lumper Service"
    data-pt="Painel do Funcion√°rio | Carolina Lumper Service">
    Employee Dashboard | Carolina Lumper Service
  </title>

  <link rel="icon" type="image/png" href="assets/CLS-favicon.png" />
  <link rel="manifest" href="manifest-employee.json">
  <meta name="theme-color" content="#ffcc00">

  <!-- iOS support -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="CLS Employee">
  <link rel="apple-touch-icon" href="assets/CLS-favicon.png">

  <!-- Feather Icons (Local - works offline!) -->
  <script src="js/feather.min.js"></script>

  <!-- Global CSS System -->
  <script>
    // Apply cache version to stylesheets dynamically
    document.write('<link rel="stylesheet" href="css/style.css?v=' + CACHE_VERSION + '">');
    document.write('<link rel="stylesheet" href="css/dashboard.css?v=' + CACHE_VERSION + '">');
  </script>
  <style>
    /* Feather Icons Spin Animation */
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    /* Time Edit Modal Styles */
    .modal {
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(4px);
    }
    .modal-content {
      background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
      margin: 5% auto;
      padding: 0;
      border: 1px solid #FFC107;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 8px 32px rgba(255, 193, 7, 0.3);
    }
    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-header h3 {
      margin: 0;
      color: #FFC107;
    }
    .close {
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: color 0.3s;
    }
    .close:hover {
      color: #FFC107;
    }
    .modal-body {
      padding: 20px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #FFC107;
      font-weight: bold;
    }
    .form-input {
      width: 100%;
      padding: 10px;
      background: #000;
      border: 1px solid #333;
      border-radius: 6px;
      color: #fff;
      font-size: 14px;
    }
    .form-input:focus {
      border-color: #FFC107;
      outline: none;
      box-shadow: 0 0 0 2px rgba(255, 193, 7, 0.2);
    }
    .readonly-field {
      padding: 10px;
      background: #111;
      border: 1px solid #333;
      border-radius: 6px;
      color: #aaa;
      display: block;
    }
    .info-text {
      font-size: 12px;
      color: #aaa;
      font-style: italic;
      margin: 0;
    }
    .modal-footer {
      padding: 20px;
      border-top: 1px solid #333;
      text-align: right;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    .status-badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
      text-transform: uppercase;
      display: inline-block;
      border: 1px solid;
    }
    .status-confirmed { 
      background: rgba(76, 175, 80, 0.2); 
      color: #4CAF50; 
      border-color: rgba(76, 175, 80, 0.4);
    }
    .status-pending { 
      background: rgba(255, 193, 7, 0.2); 
      color: #FFC107; 
      border-color: rgba(255, 193, 7, 0.4);
    }
    .status-editing { 
      background: rgba(255, 193, 7, 0.2); 
      color: #FFC107; 
      border-color: rgba(255, 193, 7, 0.4);
    }
    .status-denied { 
      background: rgba(244, 67, 54, 0.2); 
      color: #f44336; 
      border-color: rgba(244, 67, 54, 0.4);
    }
    .action-btn {
      padding: 8px 12px;
      font-size: 14px;
      border-radius: 6px;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.3s;
      background: transparent;
      border: 1px solid transparent;
      line-height: 1;
    }
    .edit-btn {
      background: rgba(255, 193, 7, 0.1);
      color: #FFC107;
      border-color: rgba(255, 193, 7, 0.3);
    }
    .edit-btn:hover:not(:disabled) {
      background: rgba(255, 193, 7, 0.3);
      transform: scale(1.1);
      color: #FFD54F;
    }
    .edit-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
      color: #666;
      background: transparent;
      border-color: transparent;
    }
    .edit-btn i {
      pointer-events: none;
    }
    /* Admin Subsection Styles */
    .admin-subsection {
      background: rgba(255, 193, 7, 0.05);
      border: 1px solid rgba(255, 193, 7, 0.2);
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      text-align: left;
      max-width: 860px;
    }
    .admin-subsection h4 {
      margin-top: 0;
      margin-bottom: 16px;
      color: #FFC107;
      font-size: 1.1em;
    }
    /* Note: Action buttons now use .btn-success and .btn-danger from dashboard.css */
    
    /* Full-Screen Loading Overlay */
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      backdrop-filter: blur(10px);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }
    
    .loading-overlay.active {
      display: flex;
    }
    
    .loading-content {
      text-align: center;
      color: #FFC107;
    }
    
    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255, 193, 7, 0.2);
      border-top-color: #FFC107;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    .loading-text {
      font-size: 18px;
      font-weight: 500;
      margin: 0;
      color: #FFC107;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Anton&display=swap" rel="stylesheet" />
</head>

<body data-page="employeeDashboard" class="dashboard-page">
  <!-- Full-Screen Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <p id="loadingText" class="loading-text">Loading...</p>
    </div>
  </div>

  <!-- Navigation Bar -->
  <div id="navbar-container"></div>


  <!-- DASHBOARD -->
  <div class="dashboard">

    <h1 id="welcomeMessage" data-en="Employee Dashboard" data-es="Panel del Empleado" data-pt="Painel do Funcion√°rio">
      Employee Dashboard</h1>
    <h2 id="welcomeName"></h2>
    <div class="info" id="userInfo"></div>

    <!-- W-9 STATUS BANNER (shown for pending/rejected only) -->
    <div id="w9StatusBanner" style="display: none; margin: var(--space-lg) 0; padding: var(--space-md); border-radius: var(--radius-md); text-align: center;">
      <span id="w9BannerIcon" style="font-size: 24px; margin-right: var(--space-sm);"></span>
      <span id="w9BannerText" style="font-weight: 600;"></span>
      <a href="w9Status.html" id="w9BannerLink" style="margin-left: var(--space-md); text-decoration: underline;">
        <span data-en="View Details" data-es="Ver Detalles" data-pt="Ver Detalhes">View Details</span>
      </a>
    </div>

    <!-- TABS -->
    <div class="tab-buttons">
      <button id="tabClock" class="tab-btn active" data-en="Clock-Ins" data-es="Entradas"
        data-pt="Registros">Clock-Ins</button>
      <button id="tabPayroll" class="tab-btn" data-en="Payroll" data-es="N√≥mina"
        data-pt="Folha de Pagamento">Payroll</button>
      <button id="tabAdmin" class="tab-btn hidden" data-en="Admin Tools" data-es="Herramientas Admin"
        data-pt="Ferramentas Admin">Admin Tools</button>
    </div>

    <!-- CLOCK-IN SECTION -->
    <div id="clockin-section" class="card">
      <button id="clockInBtn" data-en="Clock In / Out" data-es="Registrar Entrada / Salida"
        data-pt="Registrar Entrada / Sa√≠da">
        Clock In / Out
      </button>
      <div id="clockInStatus"></div>
      <div id="syncStatus"
        style="display: none; font-size: 0.9em; color: #FFC107; margin-top: 8px; text-align: center;"></div>

      <h3 class="section-title" data-en="Today's Time Entries" data-es="Entradas de Tiempo de Hoy"
        data-pt="Registros de Tempo de Hoje">
        Today's Time Entries
      </h3>
      <table id="reportTable">
        <thead>
          <tr>
            <th data-en="Date" data-es="Fecha" data-pt="Data">Date</th>
            <th data-en="Time" data-es="Hora" data-pt="Hora">Time</th>
            <th style="width: 60px; text-align: center;"></th>
          </tr>
        </thead>
        <tbody id="reportBody">
          <tr>
            <td colspan="3" class="muted">Loading...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- PAYROLL SECTION -->
    <div id="payroll-section" class="card hidden">
      <h3 class="section-title" data-en="Payroll Summary" data-es="Resumen de N√≥mina" data-pt="Resumo da Folha">
        Payroll Summary
      </h3>

      <div class="controls" style="justify-content: center; flex-direction: column; align-items: center;">
        <label for="weekPeriodSelect" style="display:flex;flex-direction:column;align-items:center;gap:8px;">
          <span data-en="Week Period:" data-es="Per√≠odo de Semana:" data-pt="Per√≠odo da Semana:">Week Period:</span>
          <select id="weekPeriodSelect"
            style="background:#000;color:#fff;border:1px solid #333;border-radius:6px;padding:8px;min-width:200px;">
            <option value="" data-en="Loading..." data-es="Cargando..." data-pt="Carregando...">Loading...</option>
          </select>
        </label>
        <button id="btnPayrollPdf" class="btn btn-secondary" data-en="Send Payroll Report"
          data-es="Enviar Informe de N√≥mina" data-pt="Enviar Relat√≥rio de Pagamento">
          Send Payroll Report
        </button>

      </div>

      <table id="payrollTable">
        <thead>
          <tr>
            <th data-en="Date" data-es="Fecha" data-pt="Data">Date</th>
            <th data-en="Hours / Break" data-es="Horas / Descanso" data-pt="Horas / Pausa">Hours / Break</th>
            <th class="t-right" data-en="Check Amount" data-es="Monto del Cheque" data-pt="Valor do Cheque">Check Amount
            </th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>


      <p id="payrollTotals" class="t-right" data-label-total-en="Total" data-label-total-es="Total"
        data-label-total-pt="Total"></p>
      <p id="payrollNone" class="muted hidden" data-en="No records found" data-es="No se encontraron registros"
        data-pt="Nenhum registro encontrado">
        No records found
      </p>
    </div>

    <!-- ADMIN SECTION -->
    <div id="admin-section" class="card hidden">
      <h3 class="section-title" data-en="Admin Tools" data-es="Herramientas de Admin" data-pt="Ferramentas de Admin">
        Admin Tools
      </h3>

      <!-- Clock-In Manager Subsection -->
      <div id="clockinManager" class="admin-subsection">
        <h4 class="section-title" data-en="Clock-In Manager" data-es="Gestor de Entradas" data-pt="Gerenciador de Registros" 
            style="padding:12px;background:rgba(255,193,7,0.1);border-radius:6px;margin-bottom:12px;">
          <span>Clock-In Manager</span>
        </h4>
        <div id="clockinManagerContent" class="admin-section-content">
        <label for="workerFilter" style="display:block;margin:12px 0;">
          <span data-en="Filter by worker:" data-es="Filtrar por empleado:" data-pt="Filtrar por funcion√°rio:">Filter by worker:</span>
          <select id="workerFilter"
            style="width:100%;background:#000;color:#fff;border:1px solid #333;border-radius:6px;padding:8px;margin-top:6px;">
            <option value="">-- All Workers --</option>
          </select>
        </label>

        <div style="display:flex;gap:8px;flex-wrap:wrap;margin:12px 0;">
          <button id="btnLoadAll" class="btn btn-primary" data-en="Load All Clock-Ins" data-es="Cargar Todas las Entradas" data-pt="Carregar Todos os Registros">Load All Clock-Ins</button>
          <button id="btnClearFilter" class="btn btn-ghost" data-en="Clear Filter" data-es="Borrar Filtro" data-pt="Limpar Filtro">Clear Filter</button>
        </div>

        <div id="allReportsContainer" style="overflow:auto;"></div>
        </div>
      </div>

      <!-- TIME EDIT REQUESTS Subsection -->
      <div id="timeEditRequestsWrap" class="admin-subsection">
        <h4 class="section-title" data-en="Time Edit Requests" data-es="Solicitudes de Edici√≥n de Tiempo"
          data-pt="Solicita√ß√µes de Edi√ß√£o de Tempo"
          style="padding:12px;background:rgba(255,193,7,0.1);border-radius:6px;margin-bottom:12px;">
          <span>Time Edit Requests</span>
        </h4>
        <div id="timeEditRequestsContent" class="admin-section-content">
        
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin:12px 0;">
          <button id="btnLoadPendingEdits" class="btn btn-primary" data-en="Load Pending Requests" 
                  data-es="Cargar Solicitudes Pendientes" data-pt="Carregar Solicita√ß√µes Pendentes">
            Load Pending Requests
          </button>
          <button id="btnLoadAllEdits" class="btn btn-ghost" data-en="Load All Requests" 
                  data-es="Cargar Todas" data-pt="Carregar Todas">
            Load All Requests
          </button>
        </div>
        
        <div id="timeEditRequestsContainer" style="overflow:auto;margin-top:12px;">
          <p class="muted" data-en="Click 'Load Pending Requests' to view time edit requests" 
             data-es="Haga clic en 'Cargar Solicitudes Pendientes' para ver las solicitudes"
             data-pt="Clique em 'Carregar Solicita√ß√µes Pendentes' para ver as solicita√ß√µes">
            Click 'Load Pending Requests' to view time edit requests
          </p>
        </div>
        </div>
      </div>

      <!-- W-9 MANAGEMENT Subsection -->
      <div id="w9ManagementWrap" class="admin-subsection">
        <h4 class="section-title" data-en="W-9 Form Management" data-es="Gesti√≥n de Formularios W-9"
          data-pt="Gerenciamento de Formul√°rios W-9"
          style="padding:12px;background:rgba(255,193,7,0.1);border-radius:6px;margin-bottom:12px;">
          <span>W-9 Form Management</span>
        </h4>
        <div id="w9ManagementContent" class="admin-section-content">
        
        <p class="muted" style="margin-bottom:12px;" 
           data-en="Review and approve W-9 submissions from 1099 contractors" 
           data-es="Revisar y aprobar env√≠os de W-9 de contratistas 1099"
           data-pt="Revisar e aprovar envios de W-9 de contratados 1099">
          Review and approve W-9 submissions from 1099 contractors
        </p>
        
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin:12px 0;">
          <button id="btnLoadPendingW9s" class="btn btn-primary" 
                  data-en="Load Pending W-9s" 
                  data-es="Cargar W-9 Pendientes" 
                  data-pt="Carregar W-9 Pendentes">
            Load Pending W-9s
          </button>
          <button id="btnRefreshW9s" class="btn btn-ghost" 
                  data-en="Refresh" 
                  data-es="Actualizar" 
                  data-pt="Atualizar">
            Refresh
          </button>
        </div>
        
        <div id="w9Container" style="overflow:auto;margin-top:12px;">
          <p class="muted" data-en="Click 'Load Pending W-9s' to view submissions awaiting approval" 
             data-es="Haga clic en 'Cargar W-9 Pendientes' para ver env√≠os en espera de aprobaci√≥n"
             data-pt="Clique em 'Carregar W-9 Pendentes' para ver envios aguardando aprova√ß√£o">
            Click 'Load Pending W-9s' to view submissions awaiting approval
          </p>
        </div>
        
        <!-- W-9 Details Modal -->
        <div id="w9DetailsModal" class="modal" style="display:none;">
          <div class="modal-content" style="max-width:600px;">
            <div class="modal-header">
              <h3 data-en="W-9 Form Details" data-es="Detalles del Formulario W-9" data-pt="Detalhes do Formul√°rio W-9">W-9 Form Details</h3>
              <span class="close" onclick="closeW9Modal()">&times;</span>
            </div>
            <div class="modal-body">
              <div id="w9DetailsContent"></div>
              
              <div class="form-group" style="margin-top:20px;">
                <label for="w9RejectionReason">
                  <span data-en="Rejection Reason (if rejecting):" 
                        data-es="Raz√≥n del Rechazo (si rechaza):" 
                        data-pt="Motivo da Rejei√ß√£o (se rejeitando):">
                    Rejection Reason (if rejecting):
                  </span>
                </label>
                <textarea id="w9RejectionReason" class="form-input" rows="3" 
                          placeholder="Enter reason for rejection..."
                          data-en="Enter reason for rejection..."
                          data-es="Ingrese la raz√≥n del rechazo..."
                          data-pt="Digite o motivo da rejei√ß√£o..."></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-ghost" onclick="closeW9Modal()"
                      data-en="Cancel" data-es="Cancelar" data-pt="Cancelar">Cancel</button>
              <button id="btnRejectW9" class="btn btn-danger" onclick="rejectW9()"
                      data-en="Reject W-9" data-es="Rechazar W-9" data-pt="Rejeitar W-9">Reject W-9</button>
              <button id="btnApproveW9" class="btn btn-success" onclick="approveW9()"
                      data-en="Approve W-9" data-es="Aprobar W-9" data-pt="Aprovar W-9">Approve W-9</button>
            </div>
          </div>
        </div>
        
        </div>
      </div>

      <!-- RUN PAYROLL Subsection -->
      <div id="runPayrollWrap" class="admin-subsection">
        <h4 class="section-title" data-en="Run Payroll" data-es="Ejecutar N√≥mina"
          data-pt="Executar Folha de Pagamento"
          style="padding:12px;background:rgba(255,193,7,0.1);border-radius:6px;margin-bottom:12px;">
          <span>Run Payroll</span>
        </h4>
        <div id="runPayrollContent" class="admin-section-content">
        
        <p class="muted" style="margin-bottom:12px;" 
           data-en="Process weekly payroll and create bills in QuickBooks" 
           data-es="Procesar n√≥mina semanal y crear facturas en QuickBooks"
           data-pt="Processar folha de pagamento semanal e criar contas no QuickBooks">
          Process weekly payroll and create bills in QuickBooks
        </p>
        
        <div style="margin-bottom:12px;">
          <label for="weekPeriodSelect" 
                 data-en="Select Week Period:" 
                 data-es="Seleccionar Per√≠odo Semanal:" 
                 data-pt="Selecionar Per√≠odo Semanal:"
                 style="display:block;margin-bottom:8px;font-weight:600;">
            Select Week Period:
          </label>
          <select id="runPayrollWeekSelect" style="width:100%;background:#000;color:#fff;border:1px solid #333;border-radius:6px;padding:8px;margin-top:6px;">
            <option value="" data-en="-- Select Week --" data-es="-- Seleccionar Semana --" data-pt="-- Selecionar Semana --">-- Select Week --</option>
          </select>
        </div>
        
        <button id="btnRunPayroll" class="btn btn-primary" style="width:100%;"
                data-en="Run Payroll" 
                data-es="Ejecutar N√≥mina" 
                data-pt="Executar Folha de Pagamento">
          Run Payroll
        </button>
        
        <div id="payrollResults" style="margin-top:12px;padding:12px;background:#f9f9f9;border:1px solid #ddd;border-radius:6px;display:none;">
          <div id="payrollStatus" style="font-weight:600;margin-bottom:8px;"></div>
          <div id="payrollMessage" style="color:#666;"></div>
        </div>
        </div>
      </div>

      <!-- QUICKBOOKS SYNC Subsection -->
      <div id="qbSyncWrap" class="admin-subsection">
        <h4 class="section-title" data-en="QuickBooks Sync" data-es="Sincronizaci√≥n de QuickBooks"
          data-pt="Sincroniza√ß√£o do QuickBooks"
          style="padding:12px;background:rgba(255,193,7,0.1);border-radius:6px;margin-bottom:12px;">
          <span>QuickBooks Sync</span>
        </h4>
        <div id="qbSyncContent" class="admin-section-content">
        
        <p class="muted" style="margin-bottom:12px;" 
           data-en="Sync active workers to QuickBooks Online as Vendors" 
           data-es="Sincronizar empleados activos a QuickBooks Online como Proveedores"
           data-pt="Sincronizar funcion√°rios ativos ao QuickBooks Online como Fornecedores">
          Sync active workers to QuickBooks Online as Vendors
        </p>
        
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin:12px 0;">
          <button id="btnSyncVendorsDryRun" class="btn btn-primary" 
                  data-en="Preview Sync (Dry Run)" 
                  data-es="Vista Previa de Sincronizaci√≥n" 
                  data-pt="Visualizar Sincroniza√ß√£o">
            Preview Sync (Dry Run)
          </button>
          <button id="btnSyncVendorsLive" class="btn btn-success" 
                  data-en="Run Sync (Live)" 
                  data-es="Ejecutar Sincronizaci√≥n" 
                  data-pt="Executar Sincroniza√ß√£o">
            Run Sync (Live)
          </button>
        </div>
        
        <div id="qbSyncResultsContainer" style="overflow:auto;margin-top:12px;max-height:400px;">
          <p class="muted" data-en="Click 'Preview Sync' to see what changes would be made" 
             data-es="Haga clic en 'Vista Previa' para ver qu√© cambios se har√≠an"
             data-pt="Clique em 'Visualizar' para ver quais altera√ß√µes seriam feitas">
            Click 'Preview Sync' to see what changes would be made
          </p>
        </div>
        </div>
      </div>
    </div>

    <!-- VIEW AS Section (Always visible for admins, above language toggle) -->
    <div id="viewAsWrap" class="hidden" style="margin: var(--space-lg) auto; max-width: 860px; padding: var(--space-md); background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius-md);">
      <h4 style="color: var(--color-primary); margin: 0 0 var(--space-md) 0; text-align: center;" 
          data-en="View As (Admin)" data-es="Ver Como (Admin)" data-pt="Ver Como (Admin)">
        View As (Admin)
      </h4>
      <label for="viewAsSelect" style="display:block;margin:12px 0;">
        <span data-en="Choose a worker:" data-es="Elija un empleado:" data-pt="Escolha um funcion√°rio:">Choose a worker:</span>
        <select id="viewAsSelect"
          style="width:100%;background:#000;color:#fff;border:1px solid #333;border-radius:6px;padding:8px;margin-top:6px;"></select>
      </label>
      <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:12px 0;">
        <button id="btnActivateViewAs" class="btn btn-primary" data-en="Activate View As" data-es="Activar Ver Como"
          data-pt="Ativar Ver Como">Activate View As</button>
        <button id="btnExitViewAs" class="btn btn-ghost hidden" data-en="Exit View As" data-es="Salir de Ver Como"
          data-pt="Sair do Ver Como">Exit View As</button>
      </div>
      <div id="viewAsBanner" class="muted hidden" style="text-align: center;"></div>
    </div>

    <!-- Language Toggle -->
    <div class="language-toggle">
      <button data-lang="en" onclick="switchLanguage('en')">English</button>
      <button data-lang="es" onclick="switchLanguage('es')">Espa√±ol</button>
      <button data-lang="pt" onclick="switchLanguage('pt')">Portugu√™s</button>
    </div>
  </div>

  <!-- Time Entry Edit Modal -->
  <div id="timeEditModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 data-en="Request Time Adjustment" data-es="Solicitar Ajuste de Tiempo" data-pt="Solicitar Ajuste de Tempo">
          Request Time Adjustment
        </h3>
        <span class="close" onclick="closeTimeEditModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <span style="font-weight:600;display:block;margin-bottom:8px;" data-en="Original Time:" data-es="Tiempo Original:" data-pt="Tempo Original:">Original Time:</span>
          <span id="originalTime" class="readonly-field"></span>
        </div>
        <div class="form-group">
          <label for="requestedTime" data-en="Requested Time:" data-es="Tiempo Solicitado:" data-pt="Tempo Solicitado:">Requested Time:</label>
          <input type="datetime-local" id="requestedTime" class="form-input" required>
        </div>
        <div class="form-group">
          <label for="editReason" data-en="Reason for Change:" data-es="Raz√≥n del Cambio:" data-pt="Motivo da Mudan√ßa:">Reason for Change:</label>
          <textarea id="editReason" class="form-input" rows="3" 
                    data-en="Please explain why this time adjustment is needed..." 
                    data-es="Por favor explique por qu√© se necesita este ajuste de tiempo..."
                    data-pt="Por favor explique por que esse ajuste de tempo √© necess√°rio..."
                    placeholder="Please explain why this time adjustment is needed..." required></textarea>
        </div>
        <div class="form-group">
          <span style="font-weight:600;display:block;margin-bottom:8px;" data-en="Note:" data-es="Nota:" data-pt="Nota:">Note:</span>
          <p class="info-text" 
             data-en="This request will be sent to your supervisor for approval. You will be notified once it's reviewed."
             data-es="Esta solicitud ser√° enviada a su supervisor para aprobaci√≥n. Se le notificar√° una vez que sea revisada."
             data-pt="Esta solicita√ß√£o ser√° enviada ao seu supervisor para aprova√ß√£o. Voc√™ ser√° notificado assim que for revisada.">
            This request will be sent to your supervisor for approval. You will be notified once it's reviewed.
          </p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-ghost" onclick="closeTimeEditModal()" 
                data-en="Cancel" data-es="Cancelar" data-pt="Cancelar">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="submitTimeEditRequest()" 
                data-en="Submit Request" data-es="Enviar Solicitud" data-pt="Enviar Solicita√ß√£o">Submit Request</button>
      </div>
    </div>
  </div>

  <script>
    // ======================== CONFIG ========================
  const API_URL = "https://cls-proxy.s-garay.workers.dev"; // Apps Script for most operations
  const SHEETS_API_URL = "https://sheets-direct-proxy.steve-3d1.workers.dev"; // Direct Sheets API (generic proxy)
    
    // Local getText function for dashboard (fallback until script.js loads)
    function getText(path, lang) {
      const dashboardTexts = {
        'dashboard.sessionExpired': {
          en: "Session expired. Please log in again.",
          es: "Sesi√≥n expirada. Por favor, inicie sesi√≥n nuevamente.",
          pt: "Sess√£o expirada. Por favor, fa√ßa login novamente."
        },
        'dashboard.greeting': {
          en: "Welcome",
          es: "¬°Bienvenido",
          pt: "Bem-vindo"
        },
        'dashboard.workerIdLabel': {
          en: "Worker ID",
          es: "ID de Empleado",
          pt: "ID do Funcion√°rio"
        },
        'pwaStatus.offlineMode': {
          en: 'Offline Mode Active',
          es: 'Modo Sin Conexi√≥n Activo',
          pt: 'Modo Offline Ativo'
        },
        'pwaStatus.installedPwa': {
          en: 'App Mode: Installed PWA',
          es: 'Modo App: PWA Instalada',
          pt: 'Modo App: PWA Instalado'
        },
        'pwaStatus.serviceWorkerActive': {
          en: 'App Mode: Online',
          es: 'Modo App: En L√≠nea',
          pt: 'Modo App: Online'
        }
      };
      
      const text = dashboardTexts[path];
      return text ? (text[lang] || text.en) : '';
    }

    // ================= Multilingual Messages =================
    const MSG = {
      gettingLocation: { en: "Getting your location...", es: "Obteniendo tu ubicaci√≥n...", pt: "Obtendo sua localiza√ß√£o..." },
      recordingClockIn: { en: "Recording clock-in...", es: "Registrando entrada...", pt: "Registrando entrada..." },
      clockInSuccess: { en: "Clock-in successful at", es: "¬°Registro exitoso en", pt: "Registro bem-sucedido em" },
      clockInFailed: { en: "Clock-in failed.", es: "Error al registrar entrada.", pt: "Falha ao registrar entrada." },
      locationDenied: { en: "Location access denied. Please enable GPS.", es: "Acceso a la ubicaci√≥n denegado. Activa el GPS.", pt: "Acesso √† localiza√ß√£o negado. Ative o GPS." },
      locationUnavailable: { en: "Location unavailable. Try again.", es: "Ubicaci√≥n no disponible. Int√©ntalo de nuevo.", pt: "Localiza√ß√£o indispon√≠vel. Tente novamente." },
      locationTimeout: { en: "Location request timed out.", es: "Solicitud de ubicaci√≥n agot√≥ el tiempo.", pt: "Solicita√ß√£o de localiza√ß√£o expirou." },
      errorPrefix: { en: "Error:", es: "Error:", pt: "Erro:" },
      loadingReport: { en: "Loading...", es: "Cargando...", pt: "Carregando..." },
      noClockIns: { en: "No clock-ins this week.", es: "No hay registros esta semana.", pt: "Sem registros esta semana." },
      reportError: { en: "Error loading report:", es: "Error al cargar el informe:", pt: "Erro ao carregar o relat√≥rio:" },
      // Offline sync messages
      offlineSaved: { en: "Clock-in saved offline ‚Äî will sync when online", es: "Registro guardado sin conexi√≥n ‚Äî se sincronizar√° cuando est√© en l√≠nea", pt: "Registro salvo offline ‚Äî ser√° sincronizado quando online" },
      syncInProgress: { en: "Connection restored ‚Äî syncing clock data...", es: "Conexi√≥n restaurada ‚Äî sincronizando datos...", pt: "Conex√£o restaurada ‚Äî sincronizando dados..." },
      syncComplete: { en: "All clock-ins synced successfully", es: "Todos los registros sincronizados", pt: "Todos os registros sincronizados" },
      pendingSync: { en: "pending sync", es: "sincronizaci√≥n pendiente", pt: "sincroniza√ß√£o pendente" },
      // Time edit messages
      timeEditRequest: { en: "Time adjustment request submitted", es: "Solicitud de ajuste de tiempo enviada", pt: "Solicita√ß√£o de ajuste de tempo enviada" },
      timeEditError: { en: "Failed to submit time adjustment request", es: "Error al enviar solicitud de ajuste", pt: "Falha ao enviar solicita√ß√£o de ajuste" },
      editButton: { en: "Edit", es: "Editar", pt: "Editar" },
      statusConfirmed: { en: "Confirmed", es: "Confirmado", pt: "Confirmado" },
      statusPending: { en: "Pending Approval", es: "Pendiente de Aprobaci√≥n", pt: "Pendente de Aprova√ß√£o" },
      statusEditing: { en: "Edit Requested", es: "Edici√≥n Solicitada", pt: "Edi√ß√£o Solicitada" },
      statusDenied: { en: "Edit Denied", es: "Edici√≥n Denegada", pt: "Edi√ß√£o Negada" },
      // Time edit approval buttons
      approveButton: { en: "‚úì Approve", es: "‚úì Aprobar", pt: "‚úì Aprovar" },
      denyButton: { en: "‚úó Deny", es: "‚úó Denegar", pt: "‚úó Negar" },
      reviewed: { en: "Reviewed", es: "Revisado", pt: "Revisado" }
    };

    // Helper function to create Feather icon element
    function createIcon(iconName) {
      // Feather icon mapping from Font Awesome names
      const iconMap = {
        'fas fa-circle': 'circle',
        'fas fa-sync-alt': 'refresh-cw',
        'fas fa-sync-alt fa-spin': 'refresh-cw',
        'fas fa-check-circle': 'check-circle',
        'fas fa-exclamation-triangle': 'alert-triangle',
        'fas fa-mobile-alt': 'smartphone',
        'fas fa-edit': 'edit-2',
        'fas fa-wifi-slash': 'wifi-off'
      };
      
      const featherName = iconMap[iconName] || iconName;
      const icon = document.createElement('i');
      icon.setAttribute('data-feather', featherName);
      
      // For spinning icons, add rotation class
      if (iconName.includes('fa-spin')) {
        icon.style.animation = 'spin 1s linear infinite';
      }
      
      return icon;
    }

    // Helper function to get MSG translations (returns plain text without HTML)
    function getMSG(key, lang = null) {
      const currentLang = lang || localStorage.getItem("CLS_Lang") || "en";
      let message = MSG[key] && MSG[key][currentLang] ? MSG[key][currentLang] : MSG[key]["en"] || "";
      // Strip HTML tags for text-only use
      return message.replace(/<[^>]*>/g, '');
    }
    
    // Helper to set status with icon
    function setStatusWithIcon(element, iconClasses, message) {
      if (!element) return;
      element.innerHTML = '';
      if (iconClasses) {
        const icon = createIcon(iconClasses);
        element.appendChild(icon);
        element.appendChild(document.createTextNode(' ' + message));
        // Replace Feather icon placeholders with actual SVG
        if (typeof feather !== 'undefined') {
          feather.replace();
        }
      } else {
        element.textContent = message;
      }
    }

    // =================== JSONP Helper ===================
    function jsonp(url) {
      return new Promise((resolve, reject) => {
        const cb = "cb_" + Math.random().toString(36).slice(2);
        const s = document.createElement("script");
        const sep = url.includes("?") ? "&" : "?";
        const fullUrl = `${url}${sep}callback=${cb}`;
        s.src = fullUrl;
        s.async = true;
        const timeout = setTimeout(() => { 
          delete window[cb]; 
          s.remove(); 
          reject(new Error("Request timed out after 30s")); 
        }, 30000);
        window[cb] = (data) => { 
          clearTimeout(timeout); 
          delete window[cb]; 
          s.remove(); 
          resolve(data); 
        };
        s.onerror = (e) => { 
          clearTimeout(timeout); 
          delete window[cb]; 
          s.remove(); 
          console.error('JSONP script load error:', e, 'URL:', fullUrl);
          reject(new Error("Script load failed - check if Cloudflare Worker is responding")); 
        };
        console.log('üì° Loading JSONP script:', fullUrl);
        document.body.appendChild(s);
      });
    }

    // =================== Offline Sync Utilities ===================
    async function sendMessageToServiceWorker(type, data = {}) {
      if (!('serviceWorker' in navigator)) return null;

      const registration = await navigator.serviceWorker.ready;
      if (!registration.active) return null;

      return new Promise((resolve) => {
        const channel = new MessageChannel();
        channel.port1.onmessage = (event) => resolve(event.data);
        registration.active.postMessage({ type, data }, [channel.port2]);
      });
    }

    async function saveClockInOffline(clockData) {
      try {
        const result = await sendMessageToServiceWorker('QUEUE_CLOCK_IN', clockData);
        return result && result.success;
      } catch (err) {
        console.error('Failed to save offline:', err);
        return false;
      }
    }

    async function triggerSync() {
      try {
        // Try background sync first
        if ('serviceWorker' in navigator && 'SyncManager' in window) {
          const registration = await navigator.serviceWorker.ready;
          await registration.sync.register('sync-clock-data');
        }

        // Also trigger manual sync
        await sendMessageToServiceWorker('TRIGGER_SYNC');
      } catch (err) {
        console.warn('Sync trigger failed:', err);
      }
    }

    async function getPendingSyncCount() {
      try {
        const result = await sendMessageToServiceWorker('GET_PENDING_COUNT');
        return result ? result.count : 0;
      } catch (err) {
        console.error('Failed to get pending count:', err);
        return 0;
      }
    }

    // Update sync status in UI
    async function updateSyncStatus() {
      const pendingCount = await getPendingSyncCount();
      const syncStatus = document.getElementById('syncStatus');
      if (syncStatus && pendingCount > 0) {
        syncStatus.innerHTML = '';
        const icon = createIcon('circle');
        icon.style.color = '#ffc107';
        icon.style.width = '12px';
        icon.style.height = '12px';
        syncStatus.appendChild(document.createTextNode(`${pendingCount} `));
        syncStatus.appendChild(icon);
        syncStatus.appendChild(document.createTextNode(' ' + getMSG('pendingSync')));
        syncStatus.style.display = 'block';
        if (typeof feather !== 'undefined') feather.replace();
      } else if (syncStatus) {
        syncStatus.style.display = 'none';
      }
    }

    // Listen for sync messages from service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.addEventListener('message', (event) => {
        const { type, data } = event.data;

        switch (type) {
          case 'CLOCK_SYNC_SUCCESS':
            updateSyncStatus();
            loadReport(); // Refresh the report
            break;
        }
      });
    }

    // Handle online/offline events (at global scope for PWA icon updates)
    window.addEventListener('online', async () => {
      updatePWAStatus();
      
      const status = document.getElementById('clockInStatus');
      const pendingCount = await getPendingSyncCount();
      
      if (pendingCount > 0 && status) {
        setStatusWithIcon(status, 'fas fa-sync-alt fa-spin', getMSG('syncInProgress'));
        
        try {
          await triggerSync();
          
          // Wait a moment for sync to complete
          setTimeout(async () => {
            const remainingCount = await getPendingSyncCount();
            if (remainingCount === 0) {
              setStatusWithIcon(status, 'check-circle', 'All clock-ins synced successfully!');
              loadReport(); // Refresh the report
              
              // Clear message after 3 seconds
              setTimeout(() => {
                if (status) status.innerHTML = '';
              }, 3000);
            } else {
              setStatusWithIcon(status, 'alert-triangle', `${remainingCount} clock-ins still pending`);
            }
          }, 2000);
        } catch (err) {
          console.error('Sync error:', err);
          setStatusWithIcon(status, 'alert-triangle', 'Sync failed: ' + err.message);
        }
      }
    });

    window.addEventListener('offline', () => {
      updatePWAStatus();
    });

    // =================== Session ===================
    const workerId = localStorage.getItem("CLS_WorkerID");
    const displayName = localStorage.getItem("CLS_WorkerName");
    const email = localStorage.getItem("CLS_Email");
    const w9Status = localStorage.getItem("CLS_W9Status"); // W-9 compliance status

    if (!workerId) {
      const currentLang = localStorage.getItem("CLS_Lang") || "en";
      alert(getText('dashboard.sessionExpired', currentLang));
      window.location.href = "employeelogin.html";
    } else {

      const userData = {
        workerId,
        displayName: displayName || `Worker ${workerId}`,
        email: email || `${workerId}@placeholder.com`
      };

      // W-9 COMPLIANCE CHECK: Redirect non-admins if W-9 not submitted
      // Check if user is admin first (admins exempt from W-9 requirement)
      const storedRole = localStorage.getItem("CLS_Role");
      if (storedRole !== 'Admin' && storedRole !== 'Lead') {
        // Only block if no W-9 submitted - must submit first
        if (!w9Status || w9Status === 'none') {
          // No W-9 submitted - redirect to form (blocking)
          window.location.href = 'w9Form.html';
        }
        // pending_admin_review, rejected, approved ‚Üí Allow dashboard access
        // Banner will show W-9 status reminder (non-blocking)
      }

    } // End of session validation

    // Global constants for dashboard
    const WORKER_ID = workerId; // Make available globally for all functions

    // View As functionality
    let VIEW_AS_WORKER = null;      // stores workerId being viewed
    let VIEW_AS_ACTIVE = false;     // mode flag
    let USER_ROLE = null;           // cached role

    // =================== INIT (All Event Bindings + Defaults) ===================
    
    // PWA Status Detection and Display (Updates navbar icon)
    let pwaStatusUpdateTimer = null;
    window.updatePWAStatus = function() {
      // Debounce to prevent redundant updates
      if (pwaStatusUpdateTimer) return;
      pwaStatusUpdateTimer = setTimeout(() => { pwaStatusUpdateTimer = null; }, 100);
      
      const pwaIcon = document.getElementById('pwaStatusIcon');
      if (!pwaIcon) {
        return; // Icon not loaded yet
      }
      
      const currentLang = localStorage.getItem("CLS_Lang") || "en";

      // Detect PWA/offline state and update icon (using Feather Icons - works offline!)
      if (!navigator.onLine) {
        // Offline mode - wifi-off icon
        pwaIcon.innerHTML = '';
        const icon = createIcon('wifi-off');
        icon.style.color = '#f44336'; // Red
        icon.style.width = '20px';
        icon.style.height = '20px';
        pwaIcon.appendChild(icon);
        pwaIcon.style.display = 'flex';
        pwaIcon.title = getText('pwaStatus.offlineMode', currentLang);
        if (typeof feather !== 'undefined') feather.replace();
      } else if (window.matchMedia('(display-mode: standalone)').matches) {
        // Running as installed PWA - check-circle icon
        pwaIcon.innerHTML = '';
        const icon = createIcon('check-circle');
        icon.style.color = '#4CAF50'; // Green
        icon.style.width = '20px';
        icon.style.height = '20px';
        pwaIcon.appendChild(icon);
        pwaIcon.style.display = 'flex';
        pwaIcon.title = getText('pwaStatus.installedPwa', currentLang);
        if (typeof feather !== 'undefined') feather.replace();
      } else if ('serviceWorker' in navigator) {
        // Service worker available - sync icon
        pwaIcon.innerHTML = '';
        const icon = createIcon('refresh-cw');
        icon.style.color = '#4CAF50'; // Green
        icon.style.width = '20px';
        icon.style.height = '20px';
        pwaIcon.appendChild(icon);
        pwaIcon.style.display = 'flex';
        pwaIcon.title = getText('pwaStatus.serviceWorkerActive', currentLang);
        if (typeof feather !== 'undefined') feather.replace();
      } else {
        // Regular web browser without service worker support - hide icon
        pwaIcon.style.display = 'none';
      }
    };

    // API call with retry logic (reduced to 1 retry to prevent excessive 60-90s timeouts)
    window.apiCallWithRetry = async function(url, maxRetries = 1) {
      for (let i = 0; i < maxRetries; i++) {
        try {
          return await jsonp(url);
        } catch (e) {
          console.warn(`API call attempt ${i + 1} failed:`, e);
          if (i === maxRetries - 1) {
            console.error('All retry attempts failed');
            throw e;
          }
          // Wait 2 seconds before retry
          await new Promise(resolve => setTimeout(resolve, 2000));
        }
      }
    };
    
    window.addEventListener("DOMContentLoaded", () => {
      // Initialize Feather Icons
      if (typeof feather !== 'undefined') {
        feather.replace();
      }
      
      const currentLang = localStorage.getItem("CLS_Lang") || "en";
      const greeting = getText('dashboard.greeting', currentLang);
      document.getElementById("welcomeName").textContent = `${greeting}, ${displayName || "Employee"}!`;
      document.getElementById("userInfo").textContent = `${getText('dashboard.workerIdLabel', currentLang)}: ${workerId} | ${email}`;

      // Listen for navbar loaded event from script.js
      window.addEventListener('navbarLoaded', () => {
        updatePWAStatus();
      });
      
      // Also check if navbar is already loaded (in case event fired before listener added)
      setTimeout(() => {
        const pwaIcon = document.getElementById('pwaStatusIcon');
        if (pwaIcon) {
          updatePWAStatus();
        }
      }, 200);
      
      // Expose function for manual testing
      window.testPWAStatus = updatePWAStatus;
      
      // Listen for language changes to update dashboard content
      window.addEventListener('languageChanged', (event) => {
        const newLang = event.detail.language;
        const greeting = getText('dashboard.greeting', newLang);
        document.getElementById("welcomeName").textContent = `${greeting}, ${displayName || "Employee"}!`;
        document.getElementById("userInfo").textContent = `${getText('dashboard.workerIdLabel', newLang)}: ${workerId} | ${email}`;
        updatePWAStatus(); // This will now work since it's in global scope
      });

      // Clock-in
      document.getElementById("clockInBtn").addEventListener("click", handleClockIn);
      loadReport();

      // Initialize sync status
      updateSyncStatus();

      // Trigger sync if back online
      if (navigator.onLine) {
        triggerSync();
      }

      // Tabs
      document.getElementById("tabClock").addEventListener("click", () => switchTab("clock"));
      document.getElementById("tabPayroll").addEventListener("click", () => switchTab("payroll"));
      
      // Admin tab (only if visible)
      const tabAdmin = document.getElementById("tabAdmin");
      if (tabAdmin) {
        tabAdmin.addEventListener("click", () => switchTab("admin"));
      }

      // Initialize to Clock-Ins tab on page load
      switchTab("clock");

      // Load week periods for payroll dropdown
      loadPayrollWeekPeriods();

      // Week period dropdown change handler
      document.getElementById("weekPeriodSelect").addEventListener("change", (e) => {
        const selectedPeriod = e.target.value;
        if (selectedPeriod) {
          loadPayroll(selectedPeriod); // Pass the ISO date directly
        }
      });

      // PDF download button
      document.getElementById("btnPayrollPdf").addEventListener("click", downloadPayrollPdf);

      // Admin panel wiring
      ensureRoleAndRevealAdmin();
      const btnLoadAll = document.getElementById('btnLoadAll');
      const btnClear = document.getElementById('btnClearFilter');
      const filterEl = document.getElementById('workerFilter');

      if (btnLoadAll) {
        btnLoadAll.addEventListener('click', () => {
          const selectedWorker = filterEl.value; // Single select value
          // If a worker is selected, filter by that worker; else load all
          loadAllReports(selectedWorker);
        });
      }
      if (btnClear) {
        btnClear.addEventListener('click', () => {
          filterEl.value = ''; // Reset to "-- All Workers --"
          loadAllReports('');
        });
      }

      // Time Edit Request buttons (Admin only)
      const btnLoadPendingEdits = document.getElementById('btnLoadPendingEdits');
      const btnLoadAllEdits = document.getElementById('btnLoadAllEdits');
      if (btnLoadPendingEdits) {
        btnLoadPendingEdits.addEventListener('click', () => loadTimeEditRequests('pending'));
      }
      if (btnLoadAllEdits) {
        btnLoadAllEdits.addEventListener('click', () => loadTimeEditRequests('all'));
      }

      // QuickBooks Sync buttons (Admin only)
      const btnSyncVendorsDryRun = document.getElementById('btnSyncVendorsDryRun');
      const btnSyncVendorsLive = document.getElementById('btnSyncVendorsLive');
      if (btnSyncVendorsDryRun) {
        btnSyncVendorsDryRun.addEventListener('click', () => triggerVendorSync(true));
      }
      if (btnSyncVendorsLive) {
        btnSyncVendorsLive.addEventListener('click', () => triggerVendorSync(false));
      }

      // Note: Run Payroll is handled by admin-tools.js ES6 module (run-payroll.js)
      // The module automatically wires up the button and populates the dropdown

      // Language init
      initLanguage();
      
      // W-9 Status Banner init
      initW9StatusBanner();
    });

    // =================== W-9 Status Banner ===================
    function initW9StatusBanner() {
      const banner = document.getElementById('w9StatusBanner');
      const icon = document.getElementById('w9BannerIcon');
      const text = document.getElementById('w9BannerText');
      const w9Status = localStorage.getItem('CLS_W9Status');
      const storedRole = localStorage.getItem('CLS_Role');
      
      // Only show for non-admin workers with pending/rejected status
      if (storedRole === 'Admin' || storedRole === 'Lead') {
        banner.style.display = 'none';
        return;
      }
      
      if (w9Status === 'pending_admin_review') {
        // Yellow banner for pending
        banner.style.display = 'block';
        banner.style.backgroundColor = 'rgba(255, 193, 7, 0.15)';
        banner.style.border = '2px solid #FFC107';
        banner.style.color = '#FFC107';
        icon.textContent = '‚è≥';
        text.textContent = 'W-9 Pending Review - Your form is being reviewed by an admin.';
        text.setAttribute('data-en', 'W-9 Pending Review - Your form is being reviewed by an admin.');
        text.setAttribute('data-es', 'Revisi√≥n de W-9 Pendiente - Su formulario est√° siendo revisado por un administrador.');
        text.setAttribute('data-pt', 'Revis√£o de W-9 Pendente - Seu formul√°rio est√° sendo revisado por um administrador.');
      } else if (w9Status === 'rejected') {
        // Red banner for rejected
        banner.style.display = 'block';
        banner.style.backgroundColor = 'rgba(239, 68, 68, 0.15)';
        banner.style.border = '2px solid #ef4444';
        banner.style.color = '#ef4444';
        icon.textContent = '‚ùå';
        text.textContent = 'W-9 Rejected - Please review the reason and resubmit.';
        text.setAttribute('data-en', 'W-9 Rejected - Please review the reason and resubmit.');
        text.setAttribute('data-es', 'W-9 Rechazado - Por favor revise el motivo y reenv√≠e.');
        text.setAttribute('data-pt', 'W-9 Rejeitado - Por favor, revise o motivo e reenvie.');
        
        // Add resubmit button for rejected status
        const resubmitBtn = document.createElement('a');
        resubmitBtn.href = 'w9Form.html';
        resubmitBtn.style.cssText = 'margin-left: var(--space-md); padding: 8px 16px; background-color: #ef4444; color: white; text-decoration: none; border-radius: var(--radius-sm); font-weight: 600; display: inline-block;';
        resubmitBtn.innerHTML = '<span data-en="Resubmit W-9" data-es="Reenviar W-9" data-pt="Reenviar W-9">Resubmit W-9</span>';
        
        // Clear any existing buttons and add new one
        const existingResubmit = banner.querySelector('a[href="w9Form.html"]');
        if (existingResubmit) {
          existingResubmit.remove();
        }
        banner.appendChild(resubmitBtn);
      } else {
        // Hide banner for 'none' or 'approved'
        banner.style.display = 'none';
      }
      
      // Reapply translations if available
      if (typeof applyTranslations === 'function') {
        applyTranslations();
      }
    }

    // =================== W-9 Status Auto-Refresh System ===================
    const W9_CHECK_COOLDOWN = 30 * 1000; // 30 seconds
    let lastW9Check = 0;
    let w9CheckCount = 0;

    async function checkW9Status(source = 'poll') {
      try {
        const workerId = localStorage.getItem('CLS_WorkerID');
        const storedRole = localStorage.getItem('CLS_Role');
        const currentStatus = localStorage.getItem('CLS_W9Status');
        
        // Only check for non-admin workers
        if (!workerId || storedRole === 'Admin' || storedRole === 'Lead') {
          return;
        }
        
        // Skip polling if already approved (no need to check)
        if (currentStatus === 'approved' && source === 'poll') {
          console.log('‚úÖ W-9 polling disabled - already approved');
          return;
        }
        
        // Cooldown check: Skip if checked within last 30 seconds
        const now = Date.now();
        if (now - lastW9Check < W9_CHECK_COOLDOWN) {
          console.log(`‚è≠Ô∏è W-9 check skipped (${source}) - checked ${Math.round((now - lastW9Check) / 1000)}s ago`);
          return;
        }
        
        lastW9Check = now;
        w9CheckCount++;
        console.log(`üîÑ W-9 status check #${w9CheckCount} (${source})`);
        
        const url = `${API_URL}?action=getW9Status&workerId=${encodeURIComponent(workerId)}`;
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success) {
          const newStatus = data.status || 'none';
          
          // If status changed, update localStorage and refresh banner
          if (currentStatus !== newStatus) {
            console.log(`üìÑ W-9 status updated: ${currentStatus} ‚Üí ${newStatus}`);
            localStorage.setItem('CLS_W9Status', newStatus);
            
            // Refresh the banner immediately
            initW9StatusBanner();
            
            // Show toast notification
            showW9StatusChangeNotification(currentStatus, newStatus);
          }
        }
      } catch (error) {
        console.warn('‚ö†Ô∏è Failed to check W-9 status:', error);
        // Fail silently - don't disrupt user experience
      }
    }

    // Show toast notification when W-9 status changes
    function showW9StatusChangeNotification(oldStatus, newStatus) {
      const statusMessages = {
        'approved': {
          icon: '‚úÖ',
          title: 'W-9 Approved',
          message: 'Your W-9 form has been approved!',
          color: '#10b981'
        },
        'rejected': {
          icon: '‚ùå',
          title: 'W-9 Rejected',
          message: 'Your W-9 form was rejected. Please review and resubmit.',
          color: '#ef4444'
        },
        'pending_admin_review': {
          icon: '‚è≥',
          title: 'W-9 Under Review',
          message: 'Your W-9 form is being reviewed.',
          color: '#FFC107'
        }
      };
      
      const config = statusMessages[newStatus];
      if (!config) return;
      
      // Create toast element
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        background: var(--bg-secondary);
        border-left: 4px solid ${config.color};
        color: var(--text-primary);
        padding: var(--space-md) var(--space-lg);
        border-radius: var(--radius-md);
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 10000;
        max-width: 350px;
        animation: slideInRight 0.3s ease-out;
      `;
      
      toast.innerHTML = `
        <div style="display: flex; align-items: start; gap: var(--space-sm);">
          <span style="font-size: 24px;">${config.icon}</span>
          <div>
            <div style="font-weight: 600; margin-bottom: 4px;">${config.title}</div>
            <div style="font-size: 14px; opacity: 0.9;">${config.message}</div>
          </div>
        </div>
      `;
      
      // Add animation keyframe if not exists
      if (!document.getElementById('toastAnimationStyle')) {
        const style = document.createElement('style');
        style.id = 'toastAnimationStyle';
        style.textContent = `
          @keyframes slideInRight {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
          }
          @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(400px); opacity: 0; }
          }
        `;
        document.head.appendChild(style);
      }
      
      document.body.appendChild(toast);
      
      // Auto-remove after 5 seconds
      setTimeout(() => {
        toast.style.animation = 'slideOutRight 0.3s ease-in';
        setTimeout(() => toast.remove(), 300);
      }, 5000);
    }

    // Start adaptive polling schedule
    function startW9StatusPolling() {
      const currentStatus = localStorage.getItem('CLS_W9Status');
      const storedRole = localStorage.getItem('CLS_Role');
      
      // Don't start polling for admins/leads
      if (storedRole === 'Admin' || storedRole === 'Lead') {
        return;
      }
      
      // Don't start polling if already approved
      if (currentStatus === 'approved') {
        console.log('‚úÖ W-9 already approved - polling not needed');
        return;
      }
      
      console.log('‚è≥ W-9 status monitoring started (pending/rejected/none)');
      
      // Adaptive schedule: 10s ‚Üí 1m ‚Üí 3m ‚Üí every 5m
      setTimeout(() => {
        checkW9Status('poll');
        setTimeout(() => {
          checkW9Status('poll');
          setTimeout(() => {
            checkW9Status('poll');
            setInterval(() => checkW9Status('poll'), 5 * 60 * 1000);
          }, 2 * 60 * 1000); // 2 more minutes = 3 min total
        }, 50 * 1000); // 50 more seconds = 1 min total
      }, 10 * 1000); // 10 seconds
    }

    // Action-triggered check wrapper
    async function checkW9BeforeAction(actionName) {
      await checkW9Status(`action:${actionName}`);
    }

    // Start polling on page load
    startW9StatusPolling();

    // =================== Load Payroll Week Periods ===================
    async function loadPayrollWeekPeriods() {
      // Check W-9 status before loading payroll
      await checkW9BeforeAction('payroll');
      
      const dropdown = document.getElementById("weekPeriodSelect");
      dropdown.innerHTML = '<option value="">Loading...</option>';

      try {
        const targetWorkerId = VIEW_AS_ACTIVE ? VIEW_AS_WORKER : workerId;
        const url = `${API_URL}?action=payrollWeekPeriods&workerId=${encodeURIComponent(targetWorkerId)}`;
        
        const data = await apiCallWithRetry(url);

        if (!data || !data.success) {
          dropdown.innerHTML = '<option value="">No data available</option>';
          return;
        }

        const periods = data.periods || [];
        
        if (periods.length === 0) {
          dropdown.innerHTML = '<option value="">No payroll periods found</option>';
          return;
        }

        // Build dropdown options (newest first)
        dropdown.innerHTML = periods.map((period, index) => {
          const weekStart = getWeekStartFromPeriod(period);
          const label = `${formatDateRange(weekStart, period)}${index === 0 ? ' (Current)' : ''}`;
          return `<option value="${period}">${label}</option>`;
        }).join('');

        // Auto-select the first (current) period and load it
        dropdown.value = periods[0];
        loadPayroll(periods[0]);

      } catch (err) {
        console.error('‚ùå Error loading payroll week periods:', err);
        dropdown.innerHTML = '<option value="">Error loading periods</option>';
      }
    }

    // Helper: Get week start from week end (Saturday)
    function getWeekStartFromPeriod(weekEndISO) {
      const weekEnd = new Date(weekEndISO + 'T00:00:00');
      const weekStart = new Date(weekEnd);
      weekStart.setDate(weekEnd.getDate() - 6);
      return weekStart.toISOString().split('T')[0];
    }

    // Helper: Format date range for display
    function formatDateRange(startISO, endISO) {
      const start = new Date(startISO + 'T00:00:00');
      const end = new Date(endISO + 'T00:00:00');
      const options = { month: 'short', day: 'numeric' };
      return `${start.toLocaleDateString('en-US', options)} - ${end.toLocaleDateString('en-US', options)}`;
    }

    // =================== Tabs ===================
    function switchTab(tab) {
      const clockBtn = document.getElementById("tabClock");
      const payBtn = document.getElementById("tabPayroll");
      const adminBtn = document.getElementById("tabAdmin");
      const clockSec = document.getElementById("clockin-section");
      const paySec = document.getElementById("payroll-section");
      const adminSec = document.getElementById("admin-section");
      
      // Remove active class from all tabs
      clockBtn.classList.remove("active");
      payBtn.classList.remove("active");
      if (adminBtn) adminBtn.classList.remove("active");
      
      // Hide all sections
      clockSec.classList.add("hidden");
      paySec.classList.add("hidden");
      if (adminSec) adminSec.classList.add("hidden");
      
      // Show selected tab
      if (tab === "clock") {
        clockBtn.classList.add("active");
        clockSec.classList.remove("hidden");
      } else if (tab === "payroll") {
        payBtn.classList.add("active");
        paySec.classList.remove("hidden");
      } else if (tab === "admin" && adminBtn && adminSec) {
        adminBtn.classList.add("active");
        adminSec.classList.remove("hidden");
      }
    }

    // =================== Logout ===================
    function logout() {
      localStorage.removeItem("CLS_WorkerID");
      localStorage.removeItem("CLS_WorkerName");
      localStorage.removeItem("CLS_Email");
      localStorage.removeItem("CLS_RememberUser");
      localStorage.removeItem("CLS_SessionExpiry");
      localStorage.removeItem("CLS_Role");
      window.location.href = "employeelogin.html";
    }

    // =================== GPS Clock-In ===================
    async function handleClockIn() {
      const btn = document.getElementById("clockInBtn");
      const status = document.getElementById("clockInStatus");
      
      // Hide button and show spinner in status
      btn.style.display = 'none';
      status.innerHTML = '<span class="btn-spinner"></span> ' + getMSG('gettingLocation');

      try {
        const pos = await new Promise((resolve, reject) =>
          navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: true,
            timeout: 10000,
          })
        );
        const { latitude, longitude } = pos.coords;

        // Prepare clock-in data
        const lang = localStorage.getItem("CLS_Lang") || "en";
        const deviceInfo = window.getDeviceInfo ? window.getDeviceInfo() : { displayString: 'Unknown Device' };
        
        // Try sending immediately (works both online and with cached service worker)
        status.innerHTML = '<span class="btn-spinner"></span> ' + getMSG('recordingClockIn');
        
        const clockInUrl = `${API_URL}?action=clockin&workerId=${encodeURIComponent(workerId)}&lat=${latitude}&lng=${longitude}&lang=${lang}&email=${encodeURIComponent(email)}&device=${encodeURIComponent(deviceInfo.displayString)}`;
        console.log('üîµ Clock-in URL:', clockInUrl);
        
        try {
          console.log('‚è±Ô∏è Sending clock-in request...');
          const res = await jsonp(clockInUrl);
          console.log('‚úÖ Clock-in response:', res);

          if (res && res.success) {
            // If backend provided a localized message (e.g. late message), show it directly
            if (res.message) {
              status.textContent = res.message;
            } else {
              const site = res.site || "Job Site";
              const dist = res.distance ? ` (${res.distance} mi)` : "";
              setStatusWithIcon(status, 'check-circle', `${getMSG('clockInSuccess')} ${site}${dist}`);
            }
            await loadReport();
          } else if (res && res.message) {
            const site = res.site ? ` (${res.site} - ${res.distance} mi)` : "";
            setStatusWithIcon(status, 'alert-triangle', `${getMSG('clockInFailed')} ${site}. ${res.message}`);
          } else {
            setStatusWithIcon(status, 'alert-triangle', getMSG('clockInFailed'));
          }
          btn.style.display = 'inline-block';
        } catch (networkErr) {
          // Network request failed - save offline
          console.error('‚ùå Clock-in request failed:', networkErr);
          const clockData = {
            workerId: workerId,
            lat: latitude,
            lng: longitude,
            lang: lang,
            email: email || '',
            device: deviceInfo.displayString,
            timestamp: new Date().toISOString()
          };
          
          const saved = await saveClockInOffline(clockData);
          if (saved) {
            setStatusWithIcon(status, 'smartphone', getMSG('offlineSaved'));
            updateSyncStatus();
          } else {
            setStatusWithIcon(status, 'alert-triangle', getMSG('clockInFailed') + " (Offline save failed)");
          }
          btn.style.display = 'inline-block';
        }
      } catch (err) {
        // Handle geolocation errors
        if (err && err.code === 1)
          setStatusWithIcon(status, 'alert-triangle', getMSG('locationDenied'));
        else if (err && err.code === 2)
          setStatusWithIcon(status, 'alert-triangle', getMSG('locationUnavailable'));
        else if (err && err.code === 3)
          setStatusWithIcon(status, 'alert-triangle', getMSG('locationTimeout'));
        else {
          // Network error - try to save offline
          if (err.message && err.message.includes("Network")) {
            try {
              const pos = await new Promise((resolve, reject) =>
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                  enableHighAccuracy: true,
                  timeout: 5000,
                })
              );

              const clockData = {
                workerId: workerId,
                lat: pos.coords.latitude,
                lng: pos.coords.longitude,
                lang: localStorage.getItem("CLS_Lang") || "en",
                email: email || '',
                timestamp: new Date().toISOString()
              };

              const saved = await saveClockInOffline(clockData);
              if (saved) {
                setStatusWithIcon(status, 'smartphone', getMSG('offlineSaved'));
                updateSyncStatus();
              } else {
                setStatusWithIcon(status, 'alert-triangle', `${getMSG('errorPrefix')} ${err.message || err}`);
              }
            } catch (geoErr) {
              setStatusWithIcon(status, 'alert-triangle', `${getMSG('errorPrefix')} ${err.message || err}`);
            }
          } else {
            setStatusWithIcon(status, 'alert-triangle', `${getMSG('errorPrefix')} ${err.message || err}`);
          }
        }
        btn.style.display = 'inline-block';
      } finally {
        // Restore button visibility
        btn.style.display = '';
      }
    }


    // =================== Time Entry Edit Functions ===================
    let currentEditEntry = null;

    async function openTimeEditModal(entryId, originalTime, canEdit = true) {
      // Check W-9 status before opening time edit modal
      await checkW9BeforeAction('timeEdit');
      
      if (!canEdit) {
        alert(getMSG('timeEditError')); // Use a better message for 'cannot edit'
        return;
      }
      
      currentEditEntry = entryId;
      document.getElementById('originalTime').textContent = originalTime;
      
      // Set default requested time to original time
      const timeInput = document.getElementById('requestedTime');
      // Convert display time to datetime-local format
      const date = new Date();
      const [time, period] = originalTime.split(' ');
      const [hours, minutes] = time.split(':');
      let hour24 = parseInt(hours);
      
      if (period === 'PM' && hour24 !== 12) hour24 += 12;
      if (period === 'AM' && hour24 === 12) hour24 = 0;
      
      const isoString = date.getFullYear() + '-' + 
                       String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                       String(date.getDate()).padStart(2, '0') + 'T' + 
                       String(hour24).padStart(2, '0') + ':' + 
                       String(minutes).padStart(2, '0');
      
      timeInput.value = isoString;
      document.getElementById('editReason').value = '';
      
      document.getElementById('timeEditModal').style.display = 'block';
    }

    function closeTimeEditModal() {
      document.getElementById('timeEditModal').style.display = 'none';
      currentEditEntry = null;
    }

    async function submitTimeEditRequest() {
      const requestedTime = document.getElementById('requestedTime').value;
      const reason = document.getElementById('editReason').value.trim();
      
      if (!requestedTime || !reason) {
        alert('Please fill in all required fields.');
        return;
      }
      
      try {
        // Format the requested time for display
        const requestedDate = new Date(requestedTime);
        const formattedTime = requestedDate.toLocaleTimeString('en-US', {
          hour: 'numeric',
          minute: '2-digit',
          hour12: true
        });
        
        const editData = {
          employeeId: workerId, // Correctly set employeeId
          recordId: currentEditEntry, // Correctly set recordId (ClockinID)
          originalTime: document.getElementById('originalTime').textContent,
          requestedTime: formattedTime,
          requestedDateTime: requestedTime,
          reason: reason,
          status: 'pending',
          submittedAt: new Date().toISOString()
        };
        
        // Submit to backend API
        const queryParams = new URLSearchParams({
          action: 'submitTimeEdit',
          employeeId: editData.employeeId,
          recordId: editData.recordId,
          originalTime: editData.originalTime,
          requestedTime: editData.requestedTime,
          requestedDateTime: editData.requestedDateTime,
          reason: editData.reason,
          status: editData.status,
          submittedAt: editData.submittedAt
        });
        
        const response = await fetch(`${API_URL}?${queryParams.toString()}`);
        
        if (response.ok) {
          alert(getMSG('timeEditRequest'));
          closeTimeEditModal();
          loadReport(); // Refresh the report to show pending status
        } else {
          throw new Error('Failed to submit request');
        }
      } catch (err) {
        console.error('Time edit submission error:', err);
        alert(getMSG('timeEditError'));
      }
    }

    // Close modal when clicking outside
    window.addEventListener('click', (event) => {
      const modal = document.getElementById('timeEditModal');
      if (event.target === modal) {
        closeTimeEditModal();
      }
    });

    // =================== Clock-In Report (Today Only, Latest First) ===================
    async function loadReport() {
      const body = document.getElementById("reportBody");
      body.innerHTML = `<tr><td colspan='3' class="muted">${getMSG('loadingReport')}</td></tr>`;

      try {
        let records = [];
        
        if (VIEW_AS_ACTIVE && USER_ROLE === 'Admin') {
          // Admin viewing as someone else - use Apps Script (has access control)
          const data = await jsonp(`${API_URL}?action=reportAs&requesterId=${encodeURIComponent(workerId)}&targetId=${encodeURIComponent(VIEW_AS_WORKER)}`);
          records = data.records || [];
        } else {
          // üöÄ HYBRID: Use direct Sheets API for faster loading (proof of concept)
          const targetWorker = workerId;
          const SPREADSHEET_ID = '1U8hSNREN5fEhskp0UM-Z80iiW39beaOj3oIsaLZyFzk';
          
          // Fetch ClockIn sheet data directly (columns: A=ClockinID, B=WorkerID, C=Date, D=Time, E=Notes, F=TaskID, G=Approve, H=Lat, I=Lng, J=NeedsProcessing, K=NearestClient, L=Distance)
          const response = await fetch(`${SHEETS_API_URL}/api/sheets/${SPREADSHEET_ID}/values/ClockIn!A2:L`);
          const result = await response.json();
          const rows = result.data?.values || [];
          
          // Calculate date range (last 7 days)
          const now = new Date();
          const weekAgo = new Date(now);
          weekAgo.setDate(now.getDate() - 7);
          weekAgo.setHours(0, 0, 0, 0);
          
          // Filter and format client-side
          records = rows
            .filter(row => {
              if (row[1] !== targetWorker) return false; // B: WorkerID
              const dateVal = row[2]; // C: Date
              const d = dateVal instanceof Date ? dateVal : new Date(dateVal);
              return !isNaN(d) && d >= weekAgo;
            })
            .map(row => {
              const dateVal = row[2]; // C: Date
              const timeVal = row[3]; // D: Time
              const d = new Date(dateVal);
              
              // Format date as MM/dd/yyyy
              const formattedDate = d.toLocaleDateString('en-US', { 
                timeZone: 'America/New_York',
                month: '2-digit',
                day: '2-digit',
                year: 'numeric'
              });
              
              // Format time
              let formattedTime = '';
              if (timeVal) {
                const t = new Date(timeVal);
                if (!isNaN(t)) {
                  formattedTime = t.toLocaleTimeString('en-US', { 
                    timeZone: 'America/New_York',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true
                  });
                } else {
                  formattedTime = String(timeVal);
                }
              }
              
              return {
                date: formattedDate,
                time: formattedTime,
                site: row[10] || '', // K: Nearest Client
                distance: row[11] || '', // L: Distance
                id: row[0] || '', // A: ClockinID
                editStatus: row[6] || 'confirmed' // G: Approve (status column)
              };
            });
        }

        body.innerHTML = "";
        // üîß Fixed: Format with leading zeros to match backend MM/dd/yyyy format
        const now = new Date();
        const formatter = new Intl.DateTimeFormat("en-US", { 
          timeZone: "America/New_York",
          month: "2-digit",
          day: "2-digit",
          year: "numeric"
        });
        const today = formatter.format(now); // e.g., "01/17/2025"
        const todayRecords = records.filter(r => r.date === today);

        if (todayRecords.length > 0) {
          todayRecords.sort((a, b) => {
            const t1 = a.time ? new Date(`1970-01-01T${a.time}`) : 0;
            const t2 = b.time ? new Date(`1970-01-01T${b.time}`) : 0;
            return t2 - t1;
          });
          
          todayRecords.forEach((r, index) => {
            const tr = document.createElement("tr");
            
            // Determine status and edit capability from backend
            const status = r.editStatus || 'confirmed';
            const canEdit = (status === 'confirmed');
            const entryId = r.id || `entry_${index}`;
            
            const editIcon = canEdit 
              ? `<button class=\"action-btn edit-btn\" onclick=\"openTimeEditModal('${entryId}', '${r.time}', true)\" title=\"${getMSG('editButton')}\"><i data-feather=\"edit-2\"></i></button>`
              : `<button class=\"action-btn edit-btn\" disabled title=\"${status === 'editing' ? 'Edit request pending' : 'Cannot edit this entry'}\"><i data-feather=\"edit-2\"></i></button>`;
            
            tr.innerHTML = `<td>${r.date}</td><td>${r.time}</td><td style="text-align: center;">${editIcon}</td>`;
            body.appendChild(tr);
          });
          // Replace Feather icon placeholders with actual SVG
          if (typeof feather !== 'undefined') feather.replace();
        } else {
          const lang = localStorage.getItem("CLS_Lang") || "en";
          body.innerHTML = `<tr><td colspan="3" class="muted">${lang === 'es' ? 'Sin registros de hoy.' :
            lang === 'pt' ? 'Sem registros de hoje.' :
              'No clock-ins today.'
            }</td></tr>`;
        }
      } catch (err) {
        console.error('Report loading error:', err);
        body.innerHTML = `<tr><td colspan="3">${getMSG('reportError')}: ${err.message || err}</td></tr>`;
      }
    }
    // Label helper for the payroll total line
    function getTotalLabelByLang() {
      const lang = localStorage.getItem("CLS_Lang") || "en";
      switch (lang) {
        case 'es': return 'Total';
        case 'pt': return 'Total';
        default: return 'Total';
      }
    }

    // Turn a Google Drive "view" URL into a direct download URL
    function driveViewToDownload(url) {
      try {
        const m = String(url).match(/\/file\/d\/([^/]+)\//);
        if (m && m[1]) return `https://drive.google.com/uc?export=download&id=${m[1]}`;
      } catch (e) { }
      // Fallback: return original URL
      return url;
    }

    // =================== Payroll (JSONP) ===================
    const baseUrl = API_URL;
    let currentWeekPeriod = null;

    async function loadPayroll(range = 'current') {
      const none = document.getElementById("payrollNone");
      const tbody = document.querySelector("#payrollTable tbody");
      const totalsEl = document.getElementById("payrollTotals");
      tbody.innerHTML = `<tr><td colspan="3" class="muted">${getMSG('loadingReport')}</td></tr>`;
      none.classList.add("hidden");
      totalsEl.textContent = "";

      try {
        let res;
        if (VIEW_AS_ACTIVE && USER_ROLE === 'Admin') {
          res = await jsonp(`${API_URL}?action=payrollAs&requesterId=${encodeURIComponent(workerId)}&targetId=${encodeURIComponent(VIEW_AS_WORKER)}&range=${range}`);
        } else {
          res = await jsonp(`${API_URL}?action=payroll&workerId=${encodeURIComponent(workerId)}&range=${range}`);
        }
        if (!res || !res.success || !res.rows) {
          tbody.innerHTML = "";
          none.classList.remove("hidden");
          return;
        }

        currentWeekPeriod = res.period?.weekEnd || null;
        if (!res.rows.length) {
          tbody.innerHTML = "";
          none.classList.remove("hidden");
          totalsEl.textContent = "";
          return;
        }

        res.rows.sort((a, b) => new Date(a.date) - new Date(b.date));
        const rowsHtml = res.rows.map(r => `
        <tr>
          <td>${r.date || ''}</td>
          <td>${r.hoursBreak || r.lineItemDetail || ''}</td>
          <td class="t-right">$${Number(r.checkAmount || 0).toFixed(2)}</td>
        </tr>`).join('');

        tbody.innerHTML = rowsHtml;
        const totalLabel = getTotalLabelByLang();
        totalsEl.textContent = `${totalLabel}: $${Number(res.totals?.checkAmountSum || 0).toFixed(2)} (${res.totals?.entries || 0} entries)`;
      } catch (err) {
        tbody.innerHTML = `<tr><td colspan="3" class="muted">Error: ${err.message || err}</td></tr>`;
        totalsEl.textContent = "";
      }
    }

    // =================== Automatic PDF Download (Direct-to-Device with Flash) ===================
    // =================== Email Payroll PDF (No Download, Multilingual) ===================
    async function downloadPayrollPdf() {
      const btn = document.getElementById("btnPayrollPdf");
      const lang = localStorage.getItem("CLS_Lang") || "en"; // üîß Fixed: Declare once at function scope

      if (!currentWeekPeriod) {
        alert(
          lang === 'es'
            ? 'Primero cargue la semana actual o anterior'
            : lang === 'pt'
              ? 'Carregue primeiro a semana atual ou anterior'
              : 'Load current or previous week first'
        );
        return;
      }

      // üåü Visual feedback (flash gold + disable)
      btn.classList.add("btn-flash");
      btn.disabled = true;
      btn.textContent =
        lang === 'es'
          ? 'Enviando...'
          : lang === 'pt'
            ? 'Enviando...'
            : 'Sending...';

      try {
        const url = `${baseUrl}?action=payrollPdf&workerId=${encodeURIComponent(
          workerId
        )}&workerName=${encodeURIComponent(
          displayName || ''
        )}&weekPeriod=${encodeURIComponent(currentWeekPeriod)}`;

        const res = await jsonp(url);

        if (res && res.success !== false) {
          alert(
            lang === 'es'
              ? '‚úÖ Informe de n√≥mina enviado a info@carolinalumpers.com'
              : lang === 'pt'
                ? '‚úÖ Relat√≥rio de pagamento enviado para info@carolinalumpers.com'
                : '‚úÖ Payroll report sent to info@carolinalumpers.com'
          );
        } else {
          alert(
            lang === 'es'
              ? '‚ö†Ô∏è No se pudo enviar el informe de n√≥mina.'
              : lang === 'pt'
                ? '‚ö†Ô∏è N√£o foi poss√≠vel enviar o relat√≥rio de pagamento.'
                : '‚ö†Ô∏è Unable to send payroll report.'
          );
        }
      } catch (err) {
        alert(
          (lang === 'es'
            ? 'Error al enviar informe: '
            : lang === 'pt'
              ? 'Erro ao enviar relat√≥rio: '
              : 'Error sending report: ') + (err.message || err)
        );
      } finally {
        btn.disabled = false;
        btn.textContent =
          lang === 'es'
            ? 'Enviar Informe de N√≥mina'
            : lang === 'pt'
              ? 'Enviar Relat√≥rio de Pagamento'
              : 'Send Payroll Report';
        btn.classList.remove("btn-flash");
      }
    }


    // =================== Language ===================
    function switchLanguage(lang) {
      // ‚úÖ Save the new language globally
      localStorage.setItem("CLS_Lang", lang);

      // Update all translatable elements
      document.querySelectorAll("[data-en]").forEach(el => {
        const t = el.getAttribute(`data-${lang}`) || el.getAttribute("data-en");
        if (t) el.innerHTML = t;
      });

      // Highlight the active language button
      document.querySelectorAll(".language-toggle button").forEach(b => {
        b.classList.toggle("active", b.dataset.lang === lang);
      });

      // ‚úÖ Update greeting text with the right language
      const displayName = localStorage.getItem("CLS_WorkerName");
      if (displayName) {
        const greeting = getText('dashboard.greeting', lang);
        document.getElementById("welcomeName").textContent = `${greeting}, ${displayName}!`;
      }

      // ‚úÖ Force-refresh visible status message if any
      const status = document.getElementById("clockInStatus");
      if (status && status.textContent) {
        status.textContent = status.textContent; // triggers re-render but doesn‚Äôt reset message
      }
    }

    function initLanguage() {
      const s = localStorage.getItem("CLS_Lang");
      const b = navigator.language || navigator.userLanguage;
      const l = s || (b?.startsWith("es") ? "es" : b?.startsWith("pt") ? "pt" : "en");
      switchLanguage(l);
    }

    // ===== Admin Role & Panel =====
    async function ensureRoleAndRevealAdmin() {
      try {
        // Load role from localStorage if present
        let storedRole = localStorage.getItem("CLS_Role");

        if (!storedRole) {
          const info = await jsonp(`${API_URL}?action=whoami&workerId=${encodeURIComponent(workerId)}`);
          if (info && info.ok && info.role) {
            storedRole = info.role;
            localStorage.setItem("CLS_Role", storedRole);
          }
        }
        // Normalize role (handle case variations)
        USER_ROLE = storedRole ? storedRole.charAt(0).toUpperCase() + storedRole.slice(1).toLowerCase() : null;

        // Show Admin tab button for Admin/Lead users (section stays hidden until tab clicked)
        if (USER_ROLE === 'Admin' || USER_ROLE === 'Lead') {
          const adminTab = document.getElementById('tabAdmin');
          
          if (adminTab) {
            adminTab.classList.remove('hidden');
          }
          // Note: admin-section stays hidden until user clicks Admin Tools tab
        }

        // Admin-only features (View As, Time Edit Requests)
        if (USER_ROLE === 'Admin') {
          // Show View As section for admins
          const viewAsWrap = document.getElementById('viewAsWrap');
          if (viewAsWrap) viewAsWrap.classList.remove('hidden');
          
          // Populate View As list and worker filter using workers from Workers sheet
          try {
            const data = await jsonp(`${API_URL}?action=reportAll&workerId=${encodeURIComponent(workerId)}`);
            
            const viewAsSelect = document.getElementById('viewAsSelect');
            const workerFilter = document.getElementById('workerFilter');
            
            if (data && data.workers && data.workers.length > 0) {
              const workers = data.workers.sort((a, b) => (a.name || a.id).localeCompare(b.name || b.id));
              
              // Populate View As dropdown
              if (viewAsSelect) {
                viewAsSelect.innerHTML = '';
                workers.forEach(w => {
                  const opt = document.createElement('option');
                  opt.value = w.id;
                  opt.textContent = `${w.name} (${w.id})`;
                  viewAsSelect.appendChild(opt);
                });
              }
              
              // Populate worker filter dropdown
              if (workerFilter) {
                workerFilter.innerHTML = '';
                workers.forEach(w => {
                  const opt = document.createElement('option');
                  opt.value = w.id;
                  opt.textContent = `${w.name} (${w.id})`;
                  workerFilter.appendChild(opt);
                });
              }
            } else {
              if (viewAsSelect) viewAsSelect.innerHTML = '<option value="">No workers found</option>';
              if (workerFilter) workerFilter.innerHTML = '<option value="">No workers found</option>';
              }
            } catch (err) {
              // Silently fail - admin features not critical
            }          document.getElementById('btnActivateViewAs').onclick = () => activateViewAs();
          document.getElementById('btnExitViewAs').onclick = () => exitViewAs();
        }
      } catch (e) {
        // silently ignore; non-admins won't see admin features
        console.log('Admin role check:', e);
      }
    }

    // ===== View As Helper Functions (kept for non-admin usage) =====
    function setViewAsBanner(targetId, name) {
      const b = document.getElementById('viewAsBanner');
      const lang = localStorage.getItem("CLS_Lang") || "en";
      
      b.classList.remove('hidden');
      b.textContent =
        (lang === 'es')
          ? `Viendo como: ${name || targetId}`
          : (lang === 'pt')
            ? `Visualizando como: ${name || targetId}`
            : `Viewing as: ${name || targetId}`;

      // Disable clock-in while viewing to avoid accidental actions
      const btn = document.getElementById('clockInBtn');
      btn.disabled = true;
      btn.title = (lang === 'es') ? 'Deshabilitado en modo Ver Como' :
        (lang === 'pt') ? 'Desativado no modo Ver Como' :
          'Disabled in View As mode';
    }

    function clearViewAsBanner() {
      const b = document.getElementById('viewAsBanner');
      b.classList.add('hidden');
      b.textContent = '';
      const btn = document.getElementById('clockInBtn');
      btn.disabled = false;
      btn.title = '';
    }

    async function activateViewAs() {
      const sel = document.getElementById('viewAsSelect');
      const targetId = sel.value;
      if (!targetId) return;

      VIEW_AS_WORKER = targetId;
      VIEW_AS_ACTIVE = true;

      // Fetch name for banner
      const who = await jsonp(`${API_URL}?action=whois&workerId=${encodeURIComponent(targetId)}`);
      setViewAsBanner(targetId, who?.displayName || '');

      document.getElementById('btnActivateViewAs').classList.add('hidden');
      document.getElementById('btnExitViewAs').classList.remove('hidden');

      // Refresh sections in View As mode
      await loadReport();
      await loadPayrollWeekPeriods(); // Reload week periods for the viewed worker
      // loadPayroll will be called automatically when a period is selected from the dropdown
    }

    function exitViewAs() {
      VIEW_AS_WORKER = null;
      VIEW_AS_ACTIVE = false;
      clearViewAsBanner();
      document.getElementById('btnExitViewAs').classList.add('hidden');
      document.getElementById('btnActivateViewAs').classList.remove('hidden');
      loadReport();
      loadPayrollWeekPeriods(); // Reload admin's own week periods
    }
    
    // ===== W-9 Management Functions =====
    let currentW9RecordId = null;
    let pendingW9List = [];
    
    // Load pending W-9 submissions
    async function loadPendingW9s() {
      const container = document.getElementById('w9Container');
      container.innerHTML = '<p class="muted">Loading...</p>';
      
      const adminId = WORKER_ID;
      
      try {
        const result = await jsonp(`${API_URL}?action=listPendingW9s&requesterId=${encodeURIComponent(adminId)}`);
        
        if (result.ok && result.pending && result.pending.length > 0) {
          pendingW9List = result.pending;
          
          let html = '<table style="width:100%;border-collapse:collapse;"><thead><tr>';
          html += '<th style="text-align:left;padding:12px;border-bottom:1px solid #333;" data-en="Worker" data-es="Empleado" data-pt="Funcion√°rio">Worker</th>';
          html += '<th style="text-align:left;padding:12px;border-bottom:1px solid #333;" data-en="Submitted" data-es="Enviado" data-pt="Enviado">Submitted</th>';
          html += '<th style="text-align:center;padding:12px;border-bottom:1px solid #333;" data-en="Actions" data-es="Acciones" data-pt="A√ß√µes">Actions</th>';
          html += '</tr></thead><tbody>';
          
          result.pending.forEach(w9 => {
            html += `<tr style="border-bottom:1px solid #222;">`;
            html += `<td style="padding:12px;">${w9.displayName || w9.workerId}<br><small style="color:#888;">${w9.workerId}</small></td>`;
            html += `<td style="padding:12px;">${formatDate(w9.submittedDate)}</td>`;
            html += `<td style="padding:12px;text-align:center;">`;
            html += `<button class="btn btn-ghost" style="padding:6px 12px;font-size:12px;margin:0 4px;" onclick="viewW9Details('${w9.w9RecordId}')" data-en="Review" data-es="Revisar" data-pt="Revisar">Review</button>`;
            if (w9.pdfUrl) {
              html += `<button class="btn btn-ghost" style="padding:6px 12px;font-size:12px;margin:0 4px;" onclick="window.open('${w9.pdfUrl}', '_blank')" data-en="View PDF" data-es="Ver PDF" data-pt="Ver PDF">View PDF</button>`;
            }
            html += `</td></tr>`;
          });
          
          html += '</tbody></table>';
          container.innerHTML = html;
          
          // Apply translations
          if (typeof applyTranslations === 'function') {
            applyTranslations();
          }
        } else {
          container.innerHTML = '<p class="muted" data-en="No pending W-9 submissions" data-es="No hay env√≠os de W-9 pendientes" data-pt="Nenhum envio de W-9 pendente">No pending W-9 submissions</p>';
          if (typeof applyTranslations === 'function') {
            applyTranslations();
          }
        }
      } catch (error) {
        console.error('Error loading pending W-9s:', error);
        container.innerHTML = '<p style="color:#ef4444;">Error loading W-9 submissions. Please try again.</p>';
      }
    }
    
    // View W-9 details in modal
    function viewW9Details(w9RecordId) {
      currentW9RecordId = w9RecordId;
      
      // Find the W-9 in the pending list
      const w9 = pendingW9List.find(w => w.w9RecordId === w9RecordId);
      
      if (!w9) {
        alert('W-9 record not found');
        return;
      }
      
      // Build details HTML
      let html = '<div style="display:flex;flex-direction:column;gap:12px;">';
      html += `<div><strong data-en="W-9 Record ID:" data-es="ID de Registro W-9:" data-pt="ID de Registro W-9:">W-9 Record ID:</strong> ${w9.w9RecordId}</div>`;
      html += `<div><strong data-en="Worker:" data-es="Empleado:" data-pt="Funcion√°rio:">Worker:</strong> ${w9.displayName} (${w9.workerId})</div>`;
      html += `<div><strong data-en="Submitted:" data-es="Enviado:" data-pt="Enviado:">Submitted:</strong> ${formatDate(w9.submittedDate)}</div>`;
      
      if (w9.pdfUrl) {
        html += `<div><a href="${w9.pdfUrl}" target="_blank" class="btn btn-primary" style="display:inline-block;padding:8px 16px;text-decoration:none;" data-en="View W-9 PDF" data-es="Ver PDF W-9" data-pt="Ver PDF W-9">View W-9 PDF</a></div>`;
      }
      
      html += '</div>';
      
      document.getElementById('w9DetailsContent').innerHTML = html;
      document.getElementById('w9RejectionReason').value = '';
      
      // Show modal
      document.getElementById('w9DetailsModal').style.display = 'block';
      
      // Apply translations
      if (typeof applyTranslations === 'function') {
        applyTranslations();
      }
    }
    
    // Close W-9 modal
    function closeW9Modal() {
      document.getElementById('w9DetailsModal').style.display = 'none';
      currentW9RecordId = null;
    }
    
    // Approve W-9
    async function approveW9() {
      if (!currentW9RecordId) return;
      
      if (!confirm('Are you sure you want to APPROVE this W-9? The worker will gain full dashboard access.')) {
        return;
      }
      
      const adminId = WORKER_ID;
      const deviceInfo = typeof getDeviceInfo === 'function' ? getDeviceInfo() : { displayString: 'Unknown' };
      
      try {
        document.getElementById('btnApproveW9').disabled = true;
        document.getElementById('btnApproveW9').textContent = 'Approving...';
        
        const result = await jsonp(`${API_URL}?action=approveW9&w9RecordId=${encodeURIComponent(currentW9RecordId)}&adminId=${encodeURIComponent(adminId)}&device=${encodeURIComponent(deviceInfo.displayString)}`);
        
        if (result.ok) {
          alert(result.message || 'W-9 approved successfully!');
          closeW9Modal();
          loadPendingW9s(); // Refresh list
        } else {
          alert(result.message || 'Failed to approve W-9');
          document.getElementById('btnApproveW9').disabled = false;
          document.getElementById('btnApproveW9').textContent = 'Approve W-9';
        }
      } catch (error) {
        console.error('Error approving W-9:', error);
        alert('Network error. Please try again.');
        document.getElementById('btnApproveW9').disabled = false;
        document.getElementById('btnApproveW9').textContent = 'Approve W-9';
      }
    }
    
    // Reject W-9
    async function rejectW9() {
      if (!currentW9RecordId) return;
      
      const reason = document.getElementById('w9RejectionReason').value.trim();
      
      if (!reason) {
        alert('Please enter a reason for rejection.');
        return;
      }
      
      if (!confirm('Are you sure you want to REJECT this W-9? The worker will be notified.')) {
        return;
      }
      
      const adminId = WORKER_ID;
      const deviceInfo = typeof getDeviceInfo === 'function' ? getDeviceInfo() : { displayString: 'Unknown' };
      
      try {
        document.getElementById('btnRejectW9').disabled = true;
        document.getElementById('btnRejectW9').textContent = 'Rejecting...';
        
        const result = await jsonp(`${API_URL}?action=rejectW9&w9RecordId=${encodeURIComponent(currentW9RecordId)}&adminId=${encodeURIComponent(adminId)}&reason=${encodeURIComponent(reason)}&device=${encodeURIComponent(deviceInfo.displayString)}`);
        
        if (result.ok) {
          alert(result.message || 'W-9 rejected successfully!');
          closeW9Modal();
          loadPendingW9s(); // Refresh list
        } else {
          alert(result.message || 'Failed to reject W-9');
          document.getElementById('btnRejectW9').disabled = false;
          document.getElementById('btnRejectW9').textContent = 'Reject W-9';
        }
      } catch (error) {
        console.error('Error rejecting W-9:', error);
        alert('Network error. Please try again.');
        document.getElementById('btnRejectW9').disabled = false;
        document.getElementById('btnRejectW9').textContent = 'Reject W-9';
      }
    }
    
    // Format date helper
    function formatDate(dateStr) {
      if (!dateStr) return 'N/A';
      try {
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', { 
          year: 'numeric', 
          month: 'short', 
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch (e) {
        return dateStr;
      }
    }
    
    // Wire up W-9 buttons
    document.addEventListener('DOMContentLoaded', () => {
      const btnLoadPendingW9s = document.getElementById('btnLoadPendingW9s');
      const btnRefreshW9s = document.getElementById('btnRefreshW9s');
      
      if (btnLoadPendingW9s) {
        btnLoadPendingW9s.addEventListener('click', loadPendingW9s);
      }
      
      if (btnRefreshW9s) {
        btnRefreshW9s.addEventListener('click', loadPendingW9s);
      }
      
      // Close modal when clicking outside
      const w9Modal = document.getElementById('w9DetailsModal');
      if (w9Modal) {
        w9Modal.addEventListener('click', (e) => {
          if (e.target === w9Modal) {
            closeW9Modal();
          }
        });
      }
    });
    
    // Make functions globally accessible
    window.viewW9Details = viewW9Details;
    window.closeW9Modal = closeW9Modal;
    window.approveW9 = approveW9;
    window.rejectW9 = rejectW9;
  </script>

  <!-- Admin Tools Module (ES6) -->
  <script type="module">
    // Import with cache version
    const adminToolsUrl = `./js/admin/admin-tools.js?v=${CACHE_VERSION}`;
    const { AdminTools } = await import(adminToolsUrl);
    
    // Initialize admin tools after DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      const apiUrl = window.API_URL || 'https://cls-proxy.s-garay.workers.dev';
      
      const adminTools = new AdminTools(apiUrl);
      adminTools.init();
      
      // Expose to window for debugging
      window.adminTools = adminTools;
    });
  </script>

  <script>
    // Service Worker Registration with Aggressive Cache Clearing for Dashboard
    if ('serviceWorker' in navigator) {
      // üî• Clear old caches immediately on page load
      const REQUIRED_VERSION = 'cls-employee-v18';
      caches.keys().then(cacheNames => {
        const oldCaches = cacheNames.filter(name => 
          name.startsWith('cls-employee-') && name !== REQUIRED_VERSION
        );
        
        if (oldCaches.length > 0) {
          Promise.all(oldCaches.map(name => caches.delete(name)))
            .then(() => {
              // Set flag to prevent reload loop
              if (!sessionStorage.getItem('cache_cleared_v18')) {
                sessionStorage.setItem('cache_cleared_v18', 'true');
                window.location.reload();
              }
            });
        }
      });

      navigator.serviceWorker.register('service-worker-employee.js?v=' + CACHE_VERSION)
        .then(registration => {
          console.log('‚úÖ SW registered on dashboard');
          console.log('üì¶ Cache version:', CACHE_VERSION);
          
          // üîß Force immediate update check on page load
          registration.update();

          // Auto-reload when new service worker takes control
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'activated' && navigator.serviceWorker.controller) {
                window.location.reload();
              }
            });
          });
        })
        .catch(err => console.error('SW registration failed:', err));

      // Listen for controller change (new SW took over)
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        window.location.reload();
      });
    }
  </script>

  <!-- Cache Busting Utility -->
  <script>
    // Apply cache version to scripts dynamically
    document.write('<script src="js/cache-buster.js?v=' + CACHE_VERSION + '" defer><\/script>');
    document.write('<script src="js/script.js?v=' + CACHE_VERSION + '" defer><\/script>');
  </script>
</body>

</html>