<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-JPETF03TJ0"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-JPETF03TJ0');
  </script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-en="Employee Login (DEV) | Carolina Lumper Service" data-es="Inicio de Sesi√≥n (DEV) | Carolina Lumper Service"
    data-pt="Login de Funcion√°rio (DEV) | Carolina Lumper Service">
    Employee Login (DEV) | Carolina Lumper Service
  </title>

  <link rel="icon" type="image/png" href="assets/CLS-favicon.png">
  <link rel="manifest" href="manifest-employee-dev.json">
  <meta name="theme-color" content="#ff9800">
  
  <!-- iOS PWA Support -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="CLS Employee DEV">
  <link rel="apple-touch-icon" href="assets/CLS-icon-192.png">
  
  <link href="https://fonts.googleapis.com/css2?family=Anton&display=swap" rel="stylesheet">
  
  <!-- Legacy CSS (loaded first) -->
  <link rel="stylesheet" href="css/style.css?v=2025-dev-offline">
  <link rel="stylesheet" href="css/forms.css?v=2025-dev-offline">
  
  <!-- Tailwind CSS (compiled with custom components - loaded last to override legacy) -->
  <link rel="stylesheet" href="css/tailwind.output.css?v=2025-tailwind">
  
  <style>
    /* Body padding for dev banner */
    body {
      padding-top: 40px;
    }
    
    /* Full-Screen Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 99999;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease-in-out;
    }
    
    .loading-overlay.active {
      opacity: 1;
      pointer-events: all;
    }
    
    .loading-content {
      text-align: center;
      animation: fadeInUp 0.6s ease-out;
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .loading-spinner-large {
      width: 80px;
      height: 80px;
      border: 6px solid #333;
      border-top: 6px solid #FFC107;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 24px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      color: #FFC107;
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 12px;
      animation: pulse 1.5s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    
    .loading-subtext {
      color: #666;
      font-size: 14px;
    }
  </style>

</head>

<body data-page="login-dev">
  <!-- Full-Screen Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
      <div class="loading-spinner-large"></div>
      <div class="loading-text" id="loadingText">‚è≥ Logging in...</div>
      <div class="loading-subtext">Verifying credentials and loading your dashboard</div>
    </div>
  </div>
  
  <!-- DEV Environment Banner -->
  <div class="fixed top-0 left-0 right-0 bg-gradient-to-r from-cls-warning to-cls-orange text-cls-charcoal py-2 px-4 text-center font-bold text-sm z-[10000] shadow-lg">
    üöß DEVELOPMENT VERSION - Testing Offline Features üöß
  </div>
  
  <!-- NAVBAR -->
  <div id="navbar-container"></div>

  <!-- LOGIN FORM (centered vertically) -->
  <main>
    <!-- PWA Install Prompt -->
    <div id="pwaInstallBanner" class="hidden card-cls border-l-4 border-cls-amber mb-4">
      <span class="text-white font-medium block mb-2" 
            data-en="üì≤ Install CLS Employee App (DEV) for faster access and offline features!"
            data-es="üì≤ ¬°Instala la App de Empleado CLS (DEV) para un acceso m√°s r√°pido!"
            data-pt="üì≤ Instale o App de Funcion√°rio CLS (DEV) para acesso mais r√°pido!">
        üì≤ Install CLS Employee App (DEV) for faster access and offline features!
      </span>
      <div class="flex gap-3 mt-4">
        <button id="installPwaBtn" class="btn-cls">
          Install
        </button>
        <button id="dismissPwaBtn" class="btn-cls-outline">
          Later
        </button>
      </div>
    </div>
    
    <!-- Offline Status Indicator -->
    <div id="offlineIndicator" class="hidden bg-cls-warning text-black px-4 py-2 text-center text-sm font-bold rounded-lg shadow-lg">
      üì± You're offline - Some features may be limited
    </div>

    <div class="max-w-md mx-auto px-4 py-8">
      <!-- Title in Dark Container -->
      <div class="card-cls mb-6">
        <h1 class="text-4xl font-bold text-center text-white" 
            data-en="Employee Login (DEV)" 
            data-es="Inicio de Sesi√≥n de Empleado (DEV)" 
            data-pt="Login de Funcion√°rio (DEV)">
          Employee Login (DEV)
        </h1>
      </div>

      <form id="loginForm" class="card-cls space-y-6">
        <input type="email" 
               id="email" 
               name="email" 
               autocomplete="email" 
               placeholder="Work Email" 
               class="input-cls"
               data-en="Work Email" 
               data-es="Correo de Trabajo" 
               data-pt="Email de Trabalho" 
               required>
        
        <input type="password" 
               id="password" 
               name="password" 
               autocomplete="current-password" 
               placeholder="Password" 
               class="input-cls"
               data-en="Password" 
               data-es="Contrase√±a" 
               data-pt="Senha" 
               required>

        <button type="submit" 
                id="loginBtn" 
                class="btn-cls"
                data-en="Login" 
                data-es="Iniciar Sesi√≥n" 
                data-pt="Entrar">
          Login
        </button>
        
        <!-- Biometric Login Section -->
        <div id="biometricSection" class="space-y-3">
          <button type="button" 
                  id="biometricLoginBtn" 
                  style="display:none;"
                  class="btn-cls-outline flex items-center justify-center gap-2">
            <img id="biometricIcon" 
                 class="w-6 h-6" 
                 src="assets/biometric/biometric-default.svg" 
                 alt="Biometric icon" />
            <span data-en="Sign in with Biometrics"
                  data-es="Iniciar sesi√≥n con biometr√≠a"
                  data-pt="Entrar com biometria">
              Sign in with Biometrics
            </span>
          </button>
          <p id="bioStatus" class="text-sm text-gray-300 text-center">
            <span class="text-gray-200" 
                  data-en="Don't have an account?" 
                  data-es="¬øNo tienes una cuenta?" 
                  data-pt="N√£o tem uma conta?">
              Don't have an account?
            </span>
            <a href="employeeSignup-dev.html" 
               class="link-cls ml-1"
               data-en="Sign Up" 
               data-es="Reg√≠strate" 
               data-pt="Cadastre-se">
              Sign Up
            </a>
          </p>
        </div>
        
        <p id="status" class="text-center text-sm text-white font-medium" role="status" aria-live="polite"></p>
      </form>

      <div class="card-cls mt-6">
        <div class="text-center">
          <a href="employeelogin.html" 
             class="link-cls inline-flex items-center gap-2">
            ‚Üê Back to Production Version
          </a>
        </div>
      </div>
    </div>
  </main>

  <!-- FOOTER -->
  <div id="footer-container"></div>

  <!-- PWA Service Worker Registration -->
  <script>
    // Service Worker Registration (DEV VERSION)
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker-employee-dev.js', { scope: './' })
        .then(registration => {
          console.log('‚úÖ [DEV] SW ready on login page:', registration.scope);
          
          // Listen for updates
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                console.log('üîÑ [DEV] New SW version available');
                // Show update prompt
                if (confirm('New version available! Reload to update?')) {
                  window.location.reload();
                }
              }
            });
          });
        })
        .catch(err => console.error('‚ùå [DEV] SW registration failed:', err));
    }
    
    // Initialize page-specific functionality after DOM is ready
    function initLoginPageFeatures() {
      console.log('üîß [DEV] Login page: Initializing page-specific features');
      
      // Update offline indicator
      function updateOfflineStatus() {
        const indicator = document.getElementById('offlineIndicator');
        if (indicator) {
          indicator.style.display = navigator.onLine ? 'none' : 'block';
        }
      }
      
      updateOfflineStatus();
      
      // Offline Login Experience
      function checkOfflineAccess() {
        if (!navigator.onLine) {
          const workerId = localStorage.getItem('CLS_WorkerID');
          const sessionExpiry = localStorage.getItem('CLS_SessionExpiry');
          
          if (workerId && sessionExpiry && new Date(sessionExpiry) > new Date()) {
            console.log('üì± [DEV] Offline mode: Redirecting to cached dashboard');
            setTimeout(() => {
              window.location.href = 'employeeDashboard-dev.html';
            }, 500);
            return;
          } else {
            const statusEl = document.getElementById('status');
            if (statusEl) {
              statusEl.textContent = 'üì± Offline: Please reconnect to log in or try again when online.';
              statusEl.style.color = '#FFC107';
            }
          }
        }
      }
      
      checkOfflineAccess();
      
      // Initialize biometric button visibility
      if (window.evaluateBiometricVisibility) {
        window.evaluateBiometricVisibility();
        console.log('‚úÖ [DEV] Biometric visibility evaluated on page load');
      } else {
        setTimeout(() => {
          if (window.evaluateBiometricVisibility) {
            window.evaluateBiometricVisibility();
            console.log('‚úÖ [DEV] Biometric visibility evaluated (delayed)');
          }
        }, 300);
      }
      
      // Listen for online/offline events
      window.addEventListener('offline', () => {
        console.log('üì± [DEV] Device went offline');
        updateOfflineStatus();
        checkOfflineAccess();
      });
      
      window.addEventListener('online', () => {
        console.log('üåê [DEV] Device back online');
        updateOfflineStatus();
        const statusEl = document.getElementById('status');
        if (statusEl && statusEl.textContent.includes('Offline:')) {
          statusEl.textContent = '';
        }
      });
    }
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initLoginPageFeatures);
    } else {
      setTimeout(initLoginPageFeatures, 100);
    }
    
    // Comprehensive failsafe system
    setTimeout(() => {
      console.log('üõ°Ô∏è [DEV] Running comprehensive failsafe checks...');
      
      if (window.initLoginForm && document.getElementById('loginForm')) {
        const form = document.getElementById('loginForm');
        if (!form.hasAttribute('data-initialized')) {
          console.log('üö® [DEV] Failsafe: Initializing login form manually');
          window.initLoginForm();
        } else {
          console.log('‚úÖ [DEV] Failsafe check: Login form already properly initialized');
        }
      }
      
      if (window.evaluateBiometricVisibility) {
        console.log('üîç [DEV] Failsafe: Re-evaluating biometric button visibility');
        window.evaluateBiometricVisibility();
      }
      
      const biometricBtn = document.getElementById('biometricLoginBtn');
      if (biometricBtn) {
        const isWebAuthnSupported = window.PublicKeyCredential && 
                                   navigator.credentials && 
                                   navigator.credentials.create;
        const isRegistered = localStorage.getItem('CLS_BioRegistered') === 'true';
        const registeredFor = localStorage.getItem('CLS_BioRegisteredFor');
        const credentialId = localStorage.getItem('CLS_BioCredentialId');
        
        console.log('üîç [DEV] Failsafe final check:', {
          webAuthnSupported: isWebAuthnSupported,
          buttonVisible: biometricBtn.style.display !== 'none',
          shouldBeVisible: isWebAuthnSupported && isRegistered && registeredFor && credentialId
        });
        
        if (isWebAuthnSupported && isRegistered && registeredFor && credentialId && biometricBtn.style.display === 'none') {
          console.log('üö® [DEV] Failsafe: Biometric button should be visible but is hidden, forcing show');
          biometricBtn.style.display = 'block';
          if (window.updateBiometricButtonText) {
            window.updateBiometricButtonText();
          }
        }
      }
    }, 1500);
  </script>

  <script src="js/script.js?v=2025-dev-offline" defer></script>
</body>

</html>
