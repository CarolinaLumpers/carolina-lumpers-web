<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biometric Test - CLS Employee App</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #444;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 14px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .status {
            background: #333;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            min-height: 50px;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196F3; }
    </style>
</head>
<body>
    <h1>🔒 CLS Biometric Authentication Test</h1>
    
    <div class="test-section">
        <h2>Environment Check</h2>
        <div id="envStatus" class="status">Checking WebAuthn support...</div>
        <button onclick="checkEnvironment()">Recheck Environment</button>
    </div>
    
    <div class="test-section">
        <h2>Registration Test</h2>
        <div id="regStatus" class="status">Ready to register credentials...</div>
        <button id="registerBtn" onclick="testRegistration()" disabled>Register Test Credential</button>
    </div>
    
    <div class="test-section">
        <h2>Authentication Test</h2>
        <div id="authStatus" class="status">Register a credential first...</div>
        <button id="authBtn" onclick="testAuthentication()" disabled>Test Authentication</button>
    </div>
    
    <div class="test-section">
        <h2>Integration Test</h2>
        <div id="intStatus" class="status">Use the buttons above to test individual components first...</div>
        <button onclick="window.open('employeelogin.html', '_blank')">Open Employee Login</button>
        <button onclick="clearTestData()">Clear Test Data</button>
    </div>

    <script>
        let testCredentialId = null;
        
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            element.innerHTML += `<div class="${type}">[${timestamp}] ${message}</div>`;
            element.scrollTop = element.scrollHeight;
        }
        
        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }
        
        async function checkEnvironment() {
            clearLog('envStatus');
            
            log('envStatus', 'Checking WebAuthn support...', 'info');
            
            // Check basic WebAuthn support
            if (!window.PublicKeyCredential) {
                log('envStatus', '❌ WebAuthn not supported (no PublicKeyCredential)', 'error');
                return false;
            }
            log('envStatus', '✅ PublicKeyCredential available', 'success');
            
            // Check credentials API
            if (!navigator.credentials) {
                log('envStatus', '❌ Credentials API not available', 'error');
                return false;
            }
            log('envStatus', '✅ Credentials API available', 'success');
            
            // Check if platform authenticator is available
            try {
                const available = await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
                if (available) {
                    log('envStatus', '✅ Platform authenticator available (Face ID/Touch ID/Windows Hello)', 'success');
                } else {
                    log('envStatus', '⚠️ Platform authenticator not available', 'warning');
                }
            } catch (err) {
                log('envStatus', `⚠️ Could not check platform authenticator: ${err.message}`, 'warning');
            }
            
            // Browser and device info
            const userAgent = navigator.userAgent;
            let browser = 'Unknown';
            if (userAgent.includes('Chrome')) browser = 'Chrome';
            else if (userAgent.includes('Firefox')) browser = 'Firefox';
            else if (userAgent.includes('Safari')) browser = 'Safari';
            else if (userAgent.includes('Edge')) browser = 'Edge';
            
            log('envStatus', `🌐 Browser: ${browser}`, 'info');
            log('envStatus', `📱 Platform: ${navigator.platform}`, 'info');
            log('envStatus', `🔒 HTTPS: ${location.protocol === 'https:' ? 'Yes' : 'No (localhost is OK)'}`, 
                location.protocol === 'https:' || location.hostname === 'localhost' ? 'success' : 'warning');
            
            // Enable registration if supported
            document.getElementById('registerBtn').disabled = false;
            log('envStatus', '✅ Environment check complete - Ready for testing!', 'success');
            return true;
        }
        
        async function testRegistration() {
            clearLog('regStatus');
            log('regStatus', 'Starting registration test...', 'info');
            
            try {
                const challenge = new Uint8Array(32);
                crypto.getRandomValues(challenge);
                
                const userId = 'test-user-' + Date.now();
                
                log('regStatus', '🔑 Creating WebAuthn credential...', 'info');
                
                const credential = await navigator.credentials.create({
                    publicKey: {
                        challenge: challenge,
                        rp: { 
                            name: 'CLS Employee Test',
                            id: window.location.hostname 
                        },
                        user: {
                            id: new TextEncoder().encode(userId),
                            name: 'test@carolinalumpers.com',
                            displayName: 'Test User'
                        },
                        pubKeyCredParams: [
                            { type: 'public-key', alg: -7 }, // ES256
                            { type: 'public-key', alg: -257 } // RS256 fallback
                        ],
                        authenticatorSelection: { 
                            userVerification: 'preferred',
                            authenticatorAttachment: 'platform'
                        },
                        timeout: 60000,
                        attestation: 'none'
                    }
                });
                
                if (credential) {
                    testCredentialId = credential.id;
                    log('regStatus', `✅ Registration successful!`, 'success');
                    log('regStatus', `📋 Credential ID: ${credential.id.substring(0, 20)}...`, 'info');
                    log('regStatus', `🔐 Type: ${credential.type}`, 'info');
                    
                    // Enable authentication test
                    document.getElementById('authBtn').disabled = false;
                    clearLog('authStatus');
                    log('authStatus', '✅ Ready for authentication test', 'success');
                }
                
            } catch (error) {
                log('regStatus', `❌ Registration failed: ${error.message}`, 'error');
                log('regStatus', `🔍 Error name: ${error.name}`, 'error');
                
                if (error.name === 'NotAllowedError') {
                    log('regStatus', '💡 This usually means the user cancelled or authentication failed', 'warning');
                } else if (error.name === 'NotSupportedError') {
                    log('regStatus', '💡 WebAuthn not supported on this device/browser', 'warning');
                }
            }
        }
        
        async function testAuthentication() {
            clearLog('authStatus');
            log('authStatus', 'Starting authentication test...', 'info');
            
            if (!testCredentialId) {
                log('authStatus', '❌ No test credential available - register first', 'error');
                return;
            }
            
            try {
                const challenge = new Uint8Array(32);
                crypto.getRandomValues(challenge);
                
                log('authStatus', '🔓 Attempting WebAuthn authentication...', 'info');
                
                const credential = await navigator.credentials.get({
                    publicKey: {
                        challenge: challenge,
                        allowCredentials: [{
                            type: 'public-key',
                            id: Uint8Array.from(atob(testCredentialId), c => c.charCodeAt(0))
                        }],
                        userVerification: 'preferred',
                        timeout: 60000
                    }
                });
                
                if (credential) {
                    log('authStatus', '✅ Authentication successful!', 'success');
                    log('authStatus', `📋 Used credential ID: ${credential.id.substring(0, 20)}...`, 'info');
                    log('authStatus', '🎉 Biometric authentication is working!', 'success');
                    
                    clearLog('intStatus');
                    log('intStatus', '✅ All tests passed - Integration ready!', 'success');
                    log('intStatus', '💡 You can now test the full employee login page', 'info');
                }
                
            } catch (error) {
                log('authStatus', `❌ Authentication failed: ${error.message}`, 'error');
                log('authStatus', `🔍 Error name: ${error.name}`, 'error');
                
                if (error.name === 'NotAllowedError') {
                    log('authStatus', '💡 User cancelled or authentication failed', 'warning');
                } else if (error.name === 'InvalidStateError') {
                    log('authStatus', '💡 Credential not found - may need to re-register', 'warning');
                }
            }
        }
        
        function clearTestData() {
            testCredentialId = null;
            document.getElementById('authBtn').disabled = true;
            clearLog('regStatus');
            clearLog('authStatus');
            clearLog('intStatus');
            log('regStatus', 'Test data cleared - ready for new test', 'info');
            log('authStatus', 'Register a credential first...', 'info');
            log('intStatus', 'Use the buttons above to test individual components first...', 'info');
        }
        
        // Auto-run environment check on load
        window.addEventListener('load', checkEnvironment);
    </script>
</body>
</html>