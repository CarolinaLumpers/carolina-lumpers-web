# Code Migration Examples - EmployeeLogin Project

This document provides before/after code examples for migrating the EmployeeLogin project to use the centralized logging library.

---

## Example 1: Clock-In Success

### Location
`CLS_EmployeeLogin_ClockIn.js` - Lines 120-145

### Before Migration
```javascript
// Generate unique clockin ID
const clockinId = 'CLK-' + Date.now();

// Append clock-in record
clockSheet.appendRow([
  new Date(),
  workerId,
  nearestClient,
  workerLat,
  workerLng,
  nearestDist.toFixed(2),
  clockinId,
  'confirmed',
  '',
  minutesLate
]);

// Log the event
logEvent_('ClockIn', {
  workerId: workerId,
  site: nearestClient,
  distance: nearestDist.toFixed(2),
  latitude: workerLat,
  longitude: workerLng,
  minutesLate: minutesLate
});
```

### After Migration
```javascript
// Generate unique clockin ID
const clockinId = 'CLK-' + Date.now();

// Get worker display name
const workerName = getWorkerDisplayName_(workerId);

// Append clock-in record
clockSheet.appendRow([
  new Date(),
  workerId,
  nearestClient,
  workerLat,
  workerLng,
  nearestDist.toFixed(2),
  clockinId,
  'confirmed',
  '',
  minutesLate
]);

// Log the event with centralized logger
TT_LOGGER.logClockIn(
  {
    workerId: workerId,
    displayName: workerName,
    device: 'Mobile App',  // Can be enhanced to get from request
    language: 'en'         // Can be enhanced to get from user prefs
  },
  {
    siteName: nearestClient,
    distance: nearestDist,
    latitude: workerLat,
    longitude: workerLng,
    clockinID: clockinId,
    minutesLate: minutesLate
  }
);
```

### Key Changes
- âœ… Added `getWorkerDisplayName_(workerId)` call to get worker name
- âœ… Replaced `logEvent_()` with `TT_LOGGER.logClockIn()`
- âœ… Structured parameters into `workerData` and `locationData` objects
- âœ… Added device and language fields (can be enhanced later)
- âœ… Distance passed as number (not string)
- âœ… ClockIn ID included for reference

---

## Example 2: Geofence Violation

### Location
`CLS_EmployeeLogin_ClockIn.js` - Lines 70-95

### Before Migration
```javascript
const subject = `ðŸš¨ Out-of-Geofence Clock-In Attempt`;
const mapsLink = `https://www.google.com/maps?q=${workerLat},${workerLng}`;
const body =
  `Worker ${workerId} attempted to clock in outside authorized area.\n\n` +
  `ðŸ“ Location: ${workerLat}, ${workerLng}\n` +
  `ðŸŒ Map: ${mapsLink}\n\n` +
  `Nearest Client: ${nearestClient || 'none'}\n` +
  `Distance: ${nearestDist.toFixed(2)} miles (limit ${GEOFENCE_RADIUS_MI} mi)\n` +
  (nearestAddr ? `Address: ${nearestAddr}\n` : '') +
  `ðŸ•’ Time: ${Utilities.formatDate(new Date(), TIMEZONE, 'yyyy-MM-dd HH:mm:ss')}`;

MailApp.sendEmail(INFO_EMAIL, subject, body);

// --- Log the geofence violation ---
logEvent_('GeofenceViolation', {
  workerId: workerId,
  latitude: workerLat,
  longitude: workerLng,
  nearestClient: nearestClient || 'none',
  distance: isFinite(nearestDist) ? nearestDist.toFixed(2) : '',
  geofenceLimit: GEOFENCE_RADIUS_MI,
  mapsLink: mapsLink
});
```

### After Migration
```javascript
const subject = `ðŸš¨ Out-of-Geofence Clock-In Attempt`;
const mapsLink = `https://www.google.com/maps?q=${workerLat},${workerLng}`;

// Get worker display name
const workerName = getWorkerDisplayName_(workerId);

const body =
  `Worker ${workerId} (${workerName}) attempted to clock in outside authorized area.\n\n` +
  `ðŸ“ Location: ${workerLat}, ${workerLng}\n` +
  `ðŸŒ Map: ${mapsLink}\n\n` +
  `Nearest Client: ${nearestClient || 'none'}\n` +
  `Distance: ${nearestDist.toFixed(2)} miles (limit ${GEOFENCE_RADIUS_MI} mi)\n` +
  (nearestAddr ? `Address: ${nearestAddr}\n` : '') +
  `ðŸ•’ Time: ${Utilities.formatDate(new Date(), TIMEZONE, 'yyyy-MM-dd HH:mm:ss')}`;

MailApp.sendEmail(INFO_EMAIL, subject, body);

// --- Log the geofence violation ---
TT_LOGGER.logGeofenceViolation(
  {
    workerId: workerId,
    displayName: workerName,
    device: 'Mobile App'
  },
  {
    latitude: workerLat,
    longitude: workerLng,
    nearestClient: nearestClient || 'Unknown',
    nearestAddress: nearestAddr || '',
    distance: nearestDist
  }
);
```

### Key Changes
- âœ… Added worker name to email body for clarity
- âœ… Replaced `logEvent_()` with `TT_LOGGER.logGeofenceViolation()`
- âœ… Distance passed as number (not string with toFixed)
- âœ… Changed 'none' to 'Unknown' for consistency
- âœ… Maps link automatically generated by logger (included in details)

---

## Example 3: Rate Limit Warning

### Location
`CLS_EmployeeLogin_ClockIn.js` - Lines 175-190

### Before Migration
```javascript
// Check if this worker clocked in recently
const recentRows = clockData.filter(r => String(r[idxWorker]) === String(workerId));
if (recentRows.length > 0) {
  const lastClockinTime = recentRows[recentRows.length - 1][idxTime];
  const diff = (now - lastClockinTime) / 60000; // minutes
  if (diff < RATE_LIMIT_MINUTES) {
    logEvent_('RateLimit', { workerId, diff, minutes: RATE_LIMIT_MINUTES });
    return {
      success: false,
      message: `â³ Please wait ${RATE_LIMIT_MINUTES} minutes between clock-ins.`
    };
  }
}
```

### After Migration
```javascript
// Check if this worker clocked in recently
const recentRows = clockData.filter(r => String(r[idxWorker]) === String(workerId));
if (recentRows.length > 0) {
  const lastClockinTime = recentRows[recentRows.length - 1][idxTime];
  const diff = (now - lastClockinTime) / 60000; // minutes
  if (diff < RATE_LIMIT_MINUTES) {
    // Get worker name for logging
    const workerName = getWorkerDisplayName_(workerId);
    
    // Log rate limit with centralized logger
    TT_LOGGER.logRateLimit(
      workerId,
      workerName,
      diff,
      RATE_LIMIT_MINUTES,
      {
        lastClockinTime: Utilities.formatDate(
          lastClockinTime, 
          TIMEZONE, 
          'yyyy-MM-dd HH:mm:ss'
        )
      }
    );
    
    return {
      success: false,
      message: `â³ Please wait ${RATE_LIMIT_MINUTES} minutes between clock-ins.`
    };
  }
}
```

### Key Changes
- âœ… Added worker name parameter
- âœ… Replaced `logEvent_()` with `TT_LOGGER.logRateLimit()`
- âœ… Added lastClockinTime to details for reference
- âœ… Formatted time for human readability

---

## Example 4: Late Arrival Email

### Location
`CLS_EmployeeLogin_ClockIn.js` - Lines 250-285

### Before Migration
```javascript
function sendLateEmail_(workerId, site, minutesLate, severity) {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  const workersSheet = ss.getSheetByName('Workers');
  const rows = workersSheet.getDataRange().getValues();
  const headers = rows[0].map(String);
  const idxId = headers.indexOf('WorkerID');
  const idxName = headers.indexOf('FullName');
  const idxEmail = headers.indexOf('Email');

  let workerName = 'Unknown Worker';
  let workerEmail = '';
  
  for (let i = 1; i < rows.length; i++) {
    if (String(rows[i][idxId]) === String(workerId)) {
      workerName = rows[i][idxName] || workerName;
      workerEmail = rows[i][idxEmail] || '';
      break;
    }
  }

  const subject = `â° Late Clock-In Alert - ${workerName}`;
  const body = `${workerName} (${workerId}) clocked in late.\n\n` +
    `Site: ${site}\n` +
    `Late by: ${minutesLate} minutes\n` +
    `Severity: ${severity}`;

  GmailApp.sendEmail(INFO_EMAIL, subject, body, { cc: CC_EMAIL });

  logEvent_('LateEmail', {
    workerId: workerId,
    site: site,
    minutesLate: minutesLate,
    severity: severity
  });
}
```

### After Migration
```javascript
function sendLateEmail_(workerId, site, minutesLate, severity, clockinTime) {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  const workersSheet = ss.getSheetByName('Workers');
  const rows = workersSheet.getDataRange().getValues();
  const headers = rows[0].map(String);
  const idxId = headers.indexOf('WorkerID');
  const idxName = headers.indexOf('FullName');
  const idxEmail = headers.indexOf('Email');

  let workerName = 'Unknown Worker';
  let workerEmail = '';
  
  for (let i = 1; i < rows.length; i++) {
    if (String(rows[i][idxId]) === String(workerId)) {
      workerName = rows[i][idxName] || workerName;
      workerEmail = rows[i][idxEmail] || '';
      break;
    }
  }

  const subject = `â° Late Clock-In Alert - ${workerName}`;
  const expectedTime = `${LATE_CLOCK_IN_HOUR}:${String(LATE_CLOCK_IN_MINUTE).padStart(2, '0')} AM`;
  const actualTime = Utilities.formatDate(clockinTime, TIMEZONE, 'hh:mm a');
  
  const body = `${workerName} (${workerId}) clocked in late.\n\n` +
    `Site: ${site}\n` +
    `Expected: ${expectedTime}\n` +
    `Actual: ${actualTime}\n` +
    `Late by: ${minutesLate} minutes\n` +
    `Severity: ${severity}`;

  GmailApp.sendEmail(INFO_EMAIL, subject, body, { cc: CC_EMAIL });

  // Log with centralized logger
  TT_LOGGER.logLateEmail(
    {
      workerId: workerId,
      displayName: workerName
    },
    {
      siteName: site,
      minutesLate: minutesLate,
      clockinTime: actualTime,
      expectedTime: expectedTime,
      severity: severity
    }
  );
}
```

### Key Changes
- âœ… Added `clockinTime` parameter to function signature
- âœ… Calculate expected and actual times for logging
- âœ… Enhanced email body with time details
- âœ… Replaced `logEvent_()` with `TT_LOGGER.logLateEmail()`
- âœ… Included recipients in logging details automatically

### Caller Update Required
Update the call to `sendLateEmail_()` to include clockinTime:
```javascript
// Before:
sendLateEmail_(workerId, nearestClient, minutesLate, severity);

// After:
sendLateEmail_(workerId, nearestClient, minutesLate, severity, now);
```

---

## Example 5: Time Edit Request

### Location
`CLS_EmployeeLogin_ClockIn.js` - Lines 430-455

### Before Migration
```javascript
function handleTimeEditRequest_() {
  try {
    const e = JSON.parse(params.data);
    const employeeId = e.employeeId;
    const recordId = e.recordId;
    const originalTime = e.originalTime;
    const requestedTime = e.requestedTime;
    const reason = e.reason || 'No reason provided';

    const ss = SpreadsheetApp.openById(SHEET_ID);
    const editSheet = getOrCreateTimeEditRequestsSheet_(ss);

    editSheet.appendRow([
      new Date(),
      employeeId,
      recordId,
      originalTime,
      requestedTime,
      reason,
      'Pending',
      ''
    ]);

    logEvent_('TimeEditRequest', {
      employeeId: employeeId,
      recordId: recordId,
      originalTime: originalTime,
      requestedTime: requestedTime,
      reason: reason
    });

    return JSON.stringify({ ok: true, message: 'Request submitted' });
  } catch (err) {
    return JSON.stringify({ ok: false, error: err.toString() });
  }
}
```

### After Migration
```javascript
function handleTimeEditRequest_() {
  try {
    const e = JSON.parse(params.data);
    const employeeId = e.employeeId;
    const recordId = e.recordId;
    const originalTime = e.originalTime;
    const requestedTime = e.requestedTime;
    const reason = e.reason || 'No reason provided';

    const ss = SpreadsheetApp.openById(SHEET_ID);
    const editSheet = getOrCreateTimeEditRequestsSheet_(ss);

    // Generate unique request ID
    const requestId = `EDIT-${Date.now()}-${Math.random().toString(36).substr(2, 4).toUpperCase()}`;
    
    // Get employee name
    const employeeName = getWorkerDisplayName_(employeeId);

    editSheet.appendRow([
      new Date(),
      employeeId,
      recordId,
      originalTime,
      requestedTime,
      reason,
      'Pending',
      '',
      requestId  // Add to sheet if column exists
    ]);

    // Log with centralized logger
    TT_LOGGER.logTimeEditRequest(
      employeeId,
      employeeName,
      requestId,
      {
        recordId: recordId,
        originalTime: originalTime,
        requestedTime: requestedTime,
        reason: reason
      }
    );

    return JSON.stringify({ ok: true, message: 'Request submitted', requestId: requestId });
  } catch (err) {
    // Log error
    TT_LOGGER.logError(
      employeeId || 'SYSTEM',
      'System',
      err.toString(),
      {
        function: 'handleTimeEditRequest_',
        stack: err.stack
      }
    );
    
    return JSON.stringify({ ok: false, error: err.toString() });
  }
}
```

### Key Changes
- âœ… Generate unique `requestId` for tracking
- âœ… Get employee name for logging
- âœ… Replaced `logEvent_()` with `TT_LOGGER.logTimeEditRequest()`
- âœ… Return `requestId` in response for frontend tracking
- âœ… Added error logging with `TT_LOGGER.logError()`
- âœ… Consider adding `requestId` column to TimeEditRequests sheet

---

## Example 6: Time Edit Approval

### Location
`CLS_EmployeeLogin_ClockIn.js` - Lines 540-575

### Before Migration
```javascript
function handleTimeEditApproval_() {
  try {
    const requestId = params.requestId;
    const approverName = params.approverName;

    const ss = SpreadsheetApp.openById(SHEET_ID);
    const editSheet = ss.getSheetByName('TimeEditRequests');
    const clockSheet = ss.getSheetByName('ClockIn');

    // Find and update request...
    // Update clock-in record...

    logEvent_('TimeEditApproved', {
      employeeId: employeeId,
      approver: approverName,
      recordId: recordId,
      oldTime: oldTime,
      newTime: newTime
    });

    return JSON.stringify({ ok: true });
  } catch (err) {
    return JSON.stringify({ ok: false, error: err.toString() });
  }
}
```

### After Migration
```javascript
function handleTimeEditApproval_() {
  try {
    const requestId = params.requestId;
    const approverName = params.approverName;

    const ss = SpreadsheetApp.openById(SHEET_ID);
    const editSheet = ss.getSheetByName('TimeEditRequests');
    const clockSheet = ss.getSheetByName('ClockIn');

    // Find and update request...
    // (existing logic to find employeeId, recordId, oldTime, newTime)
    // Update clock-in record...

    // Get employee name
    const employeeName = getWorkerDisplayName_(employeeId);

    // Log approval with centralized logger
    TT_LOGGER.logTimeEditApproval(
      employeeId,
      employeeName,
      approverName,
      requestId,
      {
        originalTime: oldTime,
        newTime: newTime,
        recordId: recordId
      }
    );

    return JSON.stringify({ ok: true, message: 'Edit approved' });
  } catch (err) {
    // Log error
    TT_LOGGER.logError(
      'ADMIN',
      approverName || 'Admin',
      err.toString(),
      {
        function: 'handleTimeEditApproval_',
        requestId: requestId,
        stack: err.stack
      }
    );
    
    return JSON.stringify({ ok: false, error: err.toString() });
  }
}
```

### Key Changes
- âœ… Get employee name for logging
- âœ… Replaced `logEvent_()` with `TT_LOGGER.logTimeEditApproval()`
- âœ… Use requestId consistently (matches frontend)
- âœ… Added error logging
- âœ… Return meaningful success message

---

## Helper Function Addition

Add this helper function to the end of `CLS_EmployeeLogin_Logger.js` (already included in the wrapper file):

```javascript
/**
 * Helper function to get worker display name from Workers sheet
 * @param {string} workerId - Worker ID
 * @returns {string} Worker's display name or worker ID if not found
 */
function getWorkerDisplayName_(workerId) {
  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    const workersSheet = ss.getSheetByName('Workers');
    
    if (!workersSheet) {
      return workerId;
    }
    
    const data = workersSheet.getDataRange().getValues();
    const headers = data[0].map(String);
    const idIdx = headers.indexOf('WorkerID');
    const nameIdx = headers.indexOf('FullName') >= 0 
      ? headers.indexOf('FullName') 
      : headers.indexOf('Name');
    
    if (idIdx < 0 || nameIdx < 0) {
      return workerId;
    }
    
    for (let i = 1; i < data.length; i++) {
      if (String(data[i][idIdx]) === String(workerId)) {
        return String(data[i][nameIdx]) || workerId;
      }
    }
    
    return workerId;
    
  } catch (error) {
    console.error('Failed to get worker display name:', error);
    return workerId;
  }
}
```

---

## Testing After Migration

After making all changes, create a comprehensive test function:

```javascript
function testAllLoggingMigration() {
  Logger.log('=== Testing Logging Migration ===');
  
  // Test 1: Clock-in
  Logger.log('Test 1: Clock-in');
  const test1 = TT_LOGGER.logClockIn(
    { workerId: 'TEST001', displayName: 'Test User', device: 'Test', language: 'en' },
    { siteName: 'Test Site', distance: 0.1, latitude: 35.77, longitude: -78.63, clockinID: 'TEST-CLK-1', minutesLate: 0 }
  );
  Logger.log('Result:', test1);
  
  // Test 2: Geofence violation
  Logger.log('Test 2: Geofence');
  const test2 = TT_LOGGER.logGeofenceViolation(
    { workerId: 'TEST002', displayName: 'Test User 2', device: 'Test' },
    { latitude: 35.77, longitude: -78.63, nearestClient: 'Test Client', distance: 0.5 }
  );
  Logger.log('Result:', test2);
  
  // Test 3: Rate limit
  Logger.log('Test 3: Rate limit');
  const test3 = TT_LOGGER.logRateLimit('TEST003', 'Test User 3', 15, 20);
  Logger.log('Result:', test3);
  
  // Test 4: Late email
  Logger.log('Test 4: Late email');
  const test4 = TT_LOGGER.logLateEmail(
    { workerId: 'TEST004', displayName: 'Test User 4' },
    { siteName: 'Test Site', minutesLate: 10, clockinTime: '8:10 AM', expectedTime: '8:00 AM', severity: 'moderate' }
  );
  Logger.log('Result:', test4);
  
  // Test 5: Time edit request
  Logger.log('Test 5: Time edit request');
  const test5 = TT_LOGGER.logTimeEditRequest(
    'TEST005',
    'Test User 5',
    'EDIT-TEST-001',
    { recordId: 'CLK-123', originalTime: '8:00 AM', requestedTime: '7:55 AM', reason: 'Test' }
  );
  Logger.log('Result:', test5);
  
  Logger.log('=== All Tests Complete ===');
  Logger.log('Check Activity_Logs sheet for entries');
}
```

---

## Summary of Changes

### Files Modified:
1. âœ… `CLS_EmployeeLogin_ClockIn.js` - All logging calls updated
2. âœ… `CLS_EmployeeLogin_Logger.js` - New wrapper file created
3. â³ `CLS_EmployeeLogin_Utils.js` - Old `logEvent_()` to be deprecated

### New Patterns:
1. âœ… Get worker name before logging
2. âœ… Use structured `TT_LOGGER` calls
3. âœ… Pass numbers (not formatted strings)
4. âœ… Generate unique IDs for requests
5. âœ… Include error logging in catch blocks
6. âœ… Return meaningful responses with IDs

### Benefits:
- âœ… Standardized logging format
- âœ… Human-readable event summaries
- âœ… AppSheet-compatible structure
- âœ… Better error tracking
- âœ… Unified activity monitoring
- âœ… GPS coordinates for mapping
- âœ… Detailed JSON for debugging
